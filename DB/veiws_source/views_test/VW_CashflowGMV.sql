select `X`.`Semana` AS `Semana`,`X`.`Comercio` AS `Comercio`,`X`.`Sucursal` AS `Sucursal`,`X`.`MedioPago` AS `MedioPago`,count(`X`.`IdPedido`) AS `Pedidos`,sum(`X`.`WebPayCredito`) AS `WebPayCredito`,sum(`X`.`WebPayDebito`) AS `WebPayDebito`,sum(`X`.`MercadoPago`) AS `MercadoPago`,sum(`X`.`Chek`) AS `Chek`,sum(`X`.`MACH`) AS `MACH`,sum(`X`.`Fpay`) AS `Fpay`,sum(`X`.`ComisionPagoNeto`) AS `ComisionPagoNeto`,sum(`X`.`ComisionPagoIva`) AS `ComisionPagoIva`,sum(`X`.`ComisionPagoBruto`) AS `ComisionPagoBruto`,sum(`X`.`IngresoPasarela`) AS `IngresoPasarela`,(((((sum(`X`.`WebPayCredito`) + sum(`X`.`WebPayDebito`)) + sum(`X`.`MercadoPago`)) + sum(`X`.`Chek`)) + sum(`X`.`MACH`)) + sum(`X`.`Fpay`)) AS `GMV`,if((`X`.`Semana` = `X`.`UltimaSemana`),(((((sum(`X`.`WebPayCredito`) + sum(`X`.`WebPayDebito`)) + sum(`X`.`MercadoPago`)) + sum(`X`.`Chek`)) + sum(`X`.`MACH`)) + sum(`X`.`Fpay`)),0) AS `GMVSemanaActual`,`X`.`UltimaSemana` AS `UltimaSemana` from (select if((dayname(`X`.`FechaPago`) = 'Sunday'),(week(`X`.`FechaPago`,0) - 1),week(`X`.`FechaPago`,0)) AS `Semana`,`X`.`Comercio` AS `Comercio`,`X`.`Sucursal` AS `Sucursal`,`X`.`IdPedido` AS `IdPedido`,`X`.`Codigo` AS `Codigo`,`X`.`Correlativo` AS `Correlativo`,`X`.`TipoPago` AS `TipoPago`,(case when ((`X`.`MedioPago` = 'WebPay') and (`X`.`TipoPago` = 'Credito')) then 'WebPayCredito' when ((`X`.`MedioPago` = 'WebPay') and (`X`.`TipoPago` = 'Debito')) then 'WebPayDebito' when (`X`.`MedioPago` = 'Mercado Pago') then 'MercadoPago' when (`X`.`MedioPago` = 'Chek') then 'Chek' when (`X`.`MedioPago` = 'MACH') then 'MACH' when (`X`.`MedioPago` = 'Fpay') then 'Fpay' end) AS `MedioPago`,ifnull(if(((`X`.`MedioPago` = 'WebPay') and (`X`.`TipoPago` = 'Credito')),`X`.`TotalBoleta`,0),0) AS `WebPayCredito`,ifnull(if(((`X`.`MedioPago` = 'WebPay') and (`X`.`TipoPago` = 'Debito')),`X`.`TotalBoleta`,0),0) AS `WebPayDebito`,ifnull(if((`X`.`MedioPago` = 'Mercado Pago'),`X`.`TotalBoleta`,0),0) AS `MercadoPago`,ifnull(if((`X`.`MedioPago` = 'Chek'),`X`.`TotalBoleta`,0),0) AS `Chek`,ifnull(if((`X`.`MedioPago` = 'MACH'),`X`.`TotalBoleta`,0),0) AS `MACH`,ifnull(if((`X`.`MedioPago` = 'Fpay'),`X`.`TotalBoleta`,0),0) AS `Fpay`,ifnull(`X`.`ComisionPagoPorcentaje`,0) AS `ComisionPagoPorcentaje`,ifnull(`X`.`ComisionPagoNeto`,0) AS `ComisionPagoNeto`,ifnull(`X`.`ComisionPagoIva`,0) AS `ComisionPagoIva`,ifnull(`X`.`ComisionPagoBruto`,0) AS `ComisionPagoBruto`,(ifnull(`X`.`TotalBoleta`,0) - ifnull(`X`.`ComisionPagoBruto`,0)) AS `IngresoPasarela`,week(`Z`.`FechaPagoMaxima`,0) AS `UltimaSemana` from (`delivery`.`dw_base_financiera` `X` join (select max(`X`.`FechaPago`) AS `FechaPagoMaxima` from `delivery`.`dw_base_financiera` `X` where ((`X`.`CodigoTipoPedido` in ('PEDNORMAL','PEDESPECIAL')) and (`X`.`EstadoPedido` <> 'Inactivo') and (`X`.`EstadoPago` in ('Activo','Reembolsado')) and (`X`.`FechaPago` >= concat(year(curdate()),'-01-01')))) `Z`) where ((`X`.`CodigoTipoPedido` in ('PEDNORMAL','PEDESPECIAL')) and (`X`.`EstadoPedido` <> 'Inactivo') and (`X`.`EstadoPago` in ('Activo','Reembolsado')) and (`X`.`FechaPago` >= concat(year(curdate()),'-01-01'))) order by `X`.`FechaPago` desc) `X` group by `X`.`Semana`,`X`.`Comercio`,`X`.`Sucursal`,`X`.`MedioPago`,`X`.`UltimaSemana` order by `X`.`Semana` desc