select `X`.`ID_PEDIDO` AS `ID_PEDIDO`,`X`.`COMERCIO` AS `1. Comercio`,`X`.`SUCURSAL` AS `2. Sucursal`,`X`.`ID_PEDIDO` AS `3. ID interno pedido`,`X`.`CODIGO` AS `4. Codigo`,`X`.`CORRELATIVO` AS `5. Correlativo`,`X`.`TIPO_ENTREGA` AS `6. Tipo Entrega`,`X`.`TIPO_FECHA_ENTREGA` AS `7. Tipo Fecha Entrega`,`X`.`FECHA_CREACION` AS `8. Fecha Creacion`,`X`.`POS_ACEPTA` AS `9. POS Quien Acepta`,`X`.`POS_TIPO_ACEPTACION` AS `10. POS Tipo Aceptacion`,`X`.`POS_FECHA_ACEPTACION_REAL` AS `11. POS Fecha Aceptacion Real`,`X`.`POS_FECHA_ACEPTACION_DESEADA` AS `12. POS Fecha Aceptacion Deseada`,timestampdiff(MINUTE,`X`.`POS_FECHA_ACEPTACION_REAL`,`X`.`POS_FECHA_ACEPTACION_DESEADA`) AS `13. DIFF: Fecha Aceptacion`,`X`.`POS_SOLICITA_DELIVERY` AS `14. POS Quien Solicita Delivery`,`X`.`POS_TIPO_SOLICITUD` AS `15. POS Tipo Solicitud Delivery`,`X`.`TIEMPO_SOLICITUD_AUTOMATICO` AS `16. POS Tiempo Solicitud Automatico (5, 10 o 15)`,`X`.`POS_FECHA_SOLICITUD_RIDER` AS `17. POS Fecha Solicitud Rider Real`,`X`.`POS_FECHA_SOLICITUD_DESEADA` AS `18. POS Fecha Solicitud Rider Deseada`,timestampdiff(MINUTE,`X`.`POS_FECHA_SOLICITUD_RIDER`,`X`.`POS_FECHA_SOLICITUD_DESEADA`) AS `19. DIFF: Fecha Solicitud Rider`,`X`.`FECHA_PRIMERA_EVIDENCIA_REAL` AS `20. POS Fecha Primera Evidencia Real`,`X`.`FECHA_PRIMERA_EVIDENCIA_DESEADA` AS `21. POS Fecha Primera Evidencia Deseada`,timestampdiff(MINUTE,`X`.`FECHA_PRIMERA_EVIDENCIA_REAL`,`X`.`FECHA_PRIMERA_EVIDENCIA_DESEADA`) AS `22. DIFF: Fecha Primera Evidencia`,`X`.`CANTIDAD_RECHAZOS_RIDER` AS `23. Cantidad Rechazos Rider`,`X`.`PRIMER_RECHAZO` AS `24. Primer Rechazo`,`X`.`ULTIMO_RECHAZO` AS `25. Ultimo Rechazo`,`X`.`CANTIDAD_DESVINCULACION_RIDER` AS `26. Cantidad Desvinculaciones`,`X`.`CODIGO_RIDER` AS `27. Codigo Rider`,`X`.`NOMBRE_RIDER` AS `28. Nombre Rider`,`X`.`TELEFONO_RIDER` AS `29. Telefono Rider`,`X`.`CORREO_RIDER` AS `30. Correo Rider`,`X`.`FECHA_ENTREGA_REAL` AS `31. Fecha Entrega Real`,`X`.`ENTREGA_PROMETIDA` AS `32. Fecha Entrega Deseada`,timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) AS `33. DIFF: Fecha Entrega`,`X`.`DIRECCION_CLIENTE` AS `34. Direccion Cliente`,`X`.`DIRECCION_SUCURSAL` AS `35. Direccion Sucursal Origen`,`X`.`DISTANCIA_KM` AS `36. Distancia KM`,`X`.`MINUTOS_PROMETIDOS` AS `37. Minutos Prometidos`,timestampdiff(MINUTE,`X`.`POS_FECHA_ACEPTACION_REAL`,`X`.`FECHA_ENTREGA_REAL`) AS `38. Minutos Totales`,timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) AS `39. KPI Calidad`,(case when ((timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) < 0) and (timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) >= -(15))) then 'VERDE' when ((timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) < -(16)) and (timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) >= -(30))) then 'AMARILLO' when (timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) < -(31)) then 'ROJO' end) AS `40. KPI QOS`,`X`.`ID_CLIENTE` AS `41. ID Cliente`,`X`.`NOMBRE_CLIENTE` AS `42. Nombre Cliente`,`X`.`TELEFONO_CLIENTE` AS `43. Telefono Cliente`,round(`X`.`SUBTOTAL`,0) AS `44. Subtotal`,round(`X`.`PROPINA`,0) AS `45. Propina`,round(`X`.`INGRESO_RIDER`,0) AS `46. Ingreso Total Rider (Incluye propina)`,round(`X`.`COSTO_DELIVERY`,0) AS `47. Costo Delivery`,`X`.`CUPON` AS `48. Cupon`,`X`.`PUNTOS_CANJEADOS` AS `49. Puntos Canjeados`,`X`.`ESTADO_PEDIDO` AS `50. Estado Pedido`,`X`.`ESTADO_PAGO` AS `51. Estado Pago`,`X`.`CALIFICACION_PEDIDO` AS `52. Calificacion Pedido`,`X`.`CALIFICACION_RIDER` AS `53. Calificacion Rider`,`X`.`PEDIDO_COURIER` AS `54. Tipo Rider` from (select `DW`.`IdPedido` AS `ID_PEDIDO`,`DW`.`Codigo` AS `CODIGO`,`DW`.`Correlativo` AS `CORRELATIVO`,`P`.`FechaCreacion` AS `FECHA_CREACION_REAL`,`DW`.`FechaCompraCliente` AS `FECHA_CREACION`,(select `X`.`Tipo` from `delivery`.`pedido_entrega_tipo_entrega` `X` where (`X`.`Id` = `PE`.`TipoEntrega`)) AS `TIPO_ENTREGA`,(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`Fecha`,'+01:00','America/Santiago'),convert_tz(`X`.`Fecha`,'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdPedido` = `DW`.`IdPedido`) and (`X`.`IdTipoSeguimiento` = 3)) limit 1) AS `FECHA_ENTREGA_REAL`,`DW`.`SubtotalProductos` AS `SUBTOTAL`,`DW`.`ComisionDeliveryWebNeto` AS `FEE_DELIVERY`,`DW`.`DeliveryAgilCharge` AS `FEE_DELIVERY_AGIL_CHARGE`,`DW`.`ComisionVentaNeto` AS `FEE_ECOMMERCE`,`DW`.`IdEstadoPedido` AS `ID_ESTADO_PEDIDO`,`DW`.`EstadoPedido` AS `ESTADO_PEDIDO`,`PP`.`IdEstado` AS `ID_ESTADO_PAGO`,`PPE`.`Nombre` AS `ESTADO_PAGO`,`DW`.`IdComercio` AS `ID_COMERCIO`,`DW`.`Comercio` AS `COMERCIO`,`DW`.`IdSucursal` AS `ID_SUCURSAL`,`DW`.`Sucursal` AS `SUCURSAL`,(case when (`PE`.`TipoFechaEntrega` = 1) then 'LO ANTES POSIBLE' when (`PE`.`TipoFechaEntrega` = 3) then 'PROGRAMADO' end) AS `TIPO_FECHA_ENTREGA`,(select concat(`X`.`Nombre`,' ',`X`.`Apellido`) AS `NOMBRE` from `delivery`.`usuario` `X` where (`X`.`IdUsuario` = (select ifnull(`PS`.`IdUsuario`,0) AS `ID_USUARIO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` in (5,13)) and (`PS`.`IdPedido` = `DW`.`IdPedido`)) limit 1))) AS `POS_ACEPTA`,(select (case when (`PS`.`IdTipoSeguimiento` = 5) then 'MANUAL' when (`PS`.`IdTipoSeguimiento` = 13) then 'AUTOMATICO' end) AS `TIPO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` in (5,13)) and (`PS`.`IdPedido` = `DW`.`IdPedido`)) limit 1) AS `POS_TIPO_ACEPTACION`,(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`Fecha`,'+01:00','America/Santiago'),convert_tz(`X`.`Fecha`,'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdTipoSeguimiento` in (5,13)) and (`X`.`IdPedido` = `DW`.`IdPedido`)) order by `X`.`Fecha` limit 1) AS `POS_FECHA_ACEPTACION_REAL`,if(((`PE`.`TipoFechaEntrega` = 1) and ((select (case when (`PS`.`IdTipoSeguimiento` = 5) then 'MANUAL' when (`PS`.`IdTipoSeguimiento` = 13) then 'AUTOMATICO' end) AS `TIPO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` in (5,13)) and (`PS`.`IdPedido` = `DW`.`IdPedido`)) limit 1) = 'AUTOMATICO')),`DW`.`FechaCompraCliente`,(`PE`.`FechaEstimadaEntrega` + interval -((ifnull((select substr(`X`.`Valor`,1,(locate('-',`X`.`Valor`) - 1)) AS `VALOR_MINIMO` from `delivery`.`sucursal_configuracion` `X` where ((`X`.`IdTipoConfiguracion` = 2) and (`X`.`IdSucursal` = `DW`.`IdSucursal`))),10) + ifnull((select substr(`X`.`Valor`,1,(locate('-',`X`.`Valor`) - 1)) AS `VALOR_MINIMO` from `delivery`.`sucursal_configuracion` `X` where ((`X`.`IdTipoConfiguracion` = 3) and (`X`.`IdSucursal` = `DW`.`IdSucursal`))),10))) minute)) AS `POS_FECHA_ACEPTACION_DESEADA`,((select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`FechaEntregaMinima`,'+01:00','America/Santiago'),convert_tz(`X`.`FechaEntregaMinima`,'+00:00','America/Santiago')) from `delivery`.`pedido_preparacion_cocina` `X` where (`X`.`IdPedido` = `DW`.`IdPedido`) limit 1) + interval -(ifnull((select if((`X`.`Valor` = 'manual'),0,`X`.`Valor`) AS `VALOR` from `delivery`.`sucursal_configuracion` `X` where ((`X`.`IdTipoConfiguracion` = 5) and (`X`.`IdSucursal` = `DW`.`IdSucursal`))),0)) minute) AS `POS_FECHA_SOLICITUD_DESEADA`,(select ifnull(`X`.`FechaLlegadaRiderSucursal`,`X`.`FechaRealRetiro`) AS `FECHA` from `delivery`.`pedido_pickup_seguimiento` `X` where (`X`.`IdPedido` = `DW`.`IdPedido`) limit 1) AS `FECHA_PRIMERA_EVIDENCIA_REAL`,(select `X`.`FechaIdealRetiro` AS `FECHA` from `delivery`.`pedido_pickup_seguimiento` `X` where (`X`.`IdPedido` = `DW`.`IdPedido`) limit 1) AS `FECHA_PRIMERA_EVIDENCIA_DESEADA`,(select concat(`X`.`Nombre`,' ',`X`.`Apellido`) AS `NOMBRE` from `delivery`.`usuario` `X` where (`X`.`IdUsuario` = (select ifnull(`PS`.`IdUsuario`,0) AS `ID_USUARIO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` in (6,7,8,9,14)) and (`PS`.`IdPedido` = `DW`.`IdPedido`)) limit 1))) AS `POS_SOLICITA_DELIVERY`,(select (case when (`PS`.`IdTipoSeguimiento` in (6,7,8,9)) then 'MANUAL' when (`PS`.`IdTipoSeguimiento` = 14) then 'AUTOMATICO' end) AS `TIPO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdPedido` = `DW`.`IdPedido`) and (`PS`.`IdTipoSeguimiento` in (6,7,8,9,14))) limit 1) AS `POS_TIPO_SOLICITUD`,ifnull((select `X`.`Valor` from `delivery`.`sucursal_configuracion` `X` where ((`X`.`IdSucursal` = `DW`.`IdSucursal`) and (`X`.`IdTipoConfiguracion` = 5)) limit 1),10) AS `TIEMPO_SOLICITUD_AUTOMATICO`,ifnull((select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`Fecha`,'+01:00','America/Santiago'),convert_tz(`X`.`Fecha`,'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdPedido` = `DW`.`IdPedido`) and (`X`.`IdTipoSeguimiento` in (6,7,8,9,14))) limit 1),(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`Fecha`,'+01:00','America/Santiago'),convert_tz(`X`.`Fecha`,'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdPedido` = `DW`.`IdPedido`) and (`X`.`IdTipoSeguimiento` in (1,4))) order by `X`.`Fecha` limit 1)) AS `POS_FECHA_SOLICITUD_RIDER`,(select count(1) AS `RECHAZOS` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` = 4) and (`PS`.`IdPedido` = `DW`.`IdPedido`))) AS `CANTIDAD_RECHAZOS_RIDER`,(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(min(`X`.`Fecha`),'+01:00','America/Santiago'),convert_tz(min(`X`.`Fecha`),'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdTipoSeguimiento` = 4) and (`X`.`IdPedido` = `DW`.`IdPedido`))) AS `PRIMER_RECHAZO`,(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(max(`X`.`Fecha`),'+01:00','America/Santiago'),convert_tz(max(`X`.`Fecha`),'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdTipoSeguimiento` = 4) and (`X`.`IdPedido` = `DW`.`IdPedido`))) AS `ULTIMO_RECHAZO`,(select count(1) AS `RECHAZOS` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` = 12) and (`PS`.`IdPedido` = `DW`.`IdPedido`))) AS `CANTIDAD_DESVINCULACION_RIDER`,`R`.`Id_Publico` AS `CODIGO_RIDER`,concat(`R`.`Nombre`,' ',`R`.`Apellido`) AS `NOMBRE_RIDER`,`RD`.`Num_Telefono` AS `TELEFONO_RIDER`,`R`.`Mail` AS `CORREO_RIDER`,`PE`.`FechaEstimadaEntrega` AS `ENTREGA_PROMETIDA`,(select `X`.`Direccion` from `delivery`.`usuario_direcciones` `X` where (`X`.`Id` = `DW`.`IdClienteDireccion`)) AS `DIRECCION_CLIENTE`,`S`.`Direccion` AS `DIRECCION_SUCURSAL`,`DW`.`DistanciaClienteTexto` AS `DISTANCIA_KM`,((select ifnull(sum(substr(`SC`.`Valor`,(locate('-',`SC`.`Valor`) + 1),length(`SC`.`Valor`))),20) AS `VALOR` from (`delivery`.`sucursal_configuracion` `SC` left join `delivery`.`sucursal_tipo_configuracion` `STC` on((`STC`.`Id` = `SC`.`IdTipoConfiguracion`))) where ((`STC`.`Id` = 2) and (`SC`.`IdSucursal` = `DW`.`IdSucursal`))) + (select ifnull(sum(substr(`SC`.`Valor`,(locate('-',`SC`.`Valor`) + 1),length(`SC`.`Valor`))),20) AS `VALOR` from (`delivery`.`sucursal_configuracion` `SC` left join `delivery`.`sucursal_tipo_configuracion` `STC` on((`STC`.`Id` = `SC`.`IdTipoConfiguracion`))) where ((`STC`.`Id` = 3) and (`SC`.`IdSucursal` = `DW`.`IdSucursal`)))) AS `MINUTOS_PROMETIDOS`,`U`.`IdUsuario` AS `ID_CLIENTE`,concat(`U`.`Nombre`,' ',`U`.`Apellido`) AS `NOMBRE_CLIENTE`,`U`.`Telefono` AS `TELEFONO_CLIENTE`,`DW`.`PropinaDelivery` AS `PROPINA`,(select `X`.`IngresoTotal` from `delivery`.`rider_facturacion_viajes` `X` where (`X`.`IdPedido` = `DW`.`IdPedido`) limit 1) AS `INGRESO_RIDER`,`DW`.`TotalDeliveryBruto` AS `COSTO_DELIVERY`,`DW`.`Cupon` AS `CUPON`,`DW`.`DsctoPuntos` AS `PUNTOS_CANJEADOS`,(select `PCC`.`Valor` from `delivery`.`pedido_cliente_calificacion` `PCC` where ((`PCC`.`IdPedido` = `DW`.`IdPedido`) and (`PCC`.`IdTipo` >= 1) and (`PCC`.`IdTipo` <= 5)) limit 1) AS `CALIFICACION_PEDIDO`,(select `PCC`.`Valor` from `delivery`.`pedido_cliente_calificacion` `PCC` where ((`PCC`.`IdPedido` = `DW`.`IdPedido`) and (`PCC`.`IdTipo` >= 6) and (`PCC`.`IdTipo` <= 10)) limit 1) AS `CALIFICACION_RIDER`,(select `TCR`.`Nombre` from (`delivery`.`pedido_courier` `PCR` left join `delivery`.`tipo_courier` `TCR` on((`TCR`.`IdCourier` = `PCR`.`IdTipoCourier`))) where (`PCR`.`IdPedido` = `DW`.`IdPedido`) limit 1) AS `PEDIDO_COURIER` from ((((((((`delivery`.`dw_pedido` `DW` left join `delivery`.`pedidos` `P` on((`P`.`IdPedido` = `DW`.`IdPedido`))) left join `delivery`.`pedido_pago` `PP` on((`PP`.`IdPedido` = `DW`.`IdPedido`))) left join `delivery`.`pedido_pago_estado` `PPE` on((`PP`.`IdEstado` = `PPE`.`Id`))) left join `delivery`.`pedido_entrega` `PE` on((`PE`.`IdPedido` = `DW`.`IdPedido`))) left join `delivery`.`rider` `R` on((`R`.`Id_Rider` = `DW`.`IdRider`))) left join `delivery`.`sucursal` `S` on((`S`.`IdSucursal` = `DW`.`IdSucursal`))) left join `delivery`.`usuario` `U` on((`U`.`IdUsuario` = `DW`.`IdCliente`))) left join `delivery`.`rider_dispositivo` `RD` on((`RD`.`Id_Rider` = `R`.`Id_Rider`))) where ((`DW`.`IdEstadoPedido` in (3,8,9,10,11,12)) and (`DW`.`TipoEntrega` = 'Delivery') and (`PPE`.`Id` in (1,16)) and (`DW`.`FechaCompraCliente` >= '2022-09-13 00:00:00') and (`DW`.`FechaCompraCliente` < concat(curdate(),' 00:00:00'))) order by `DW`.`IdPedido` desc) `X` union all select `X`.`ID_PEDIDO` AS `ID_PEDIDO`,`X`.`COMERCIO` AS `1. Comercio`,`X`.`SUCURSAL` AS `2. Sucursal`,`X`.`ID_PEDIDO` AS `3. ID interno pedido`,`X`.`CODIGO` AS `4. Codigo`,`X`.`CORRELATIVO` AS `5. Correlativo`,`X`.`TIPO_ENTREGA` AS `6. Tipo Entrega`,`X`.`TIPO_FECHA_ENTREGA` AS `7. Tipo Fecha Entrega`,`X`.`FECHA_CREACION` AS `8. Fecha Creacion`,`X`.`POS_ACEPTA` AS `9. POS Quien Acepta`,`X`.`POS_TIPO_ACEPTACION` AS `10. POS Tipo Aceptacion`,`X`.`POS_FECHA_ACEPTACION_REAL` AS `11. POS Fecha Aceptacion Real`,`X`.`POS_FECHA_ACEPTACION_DESEADA` AS `12. POS Fecha Aceptacion Deseada`,timestampdiff(MINUTE,`X`.`POS_FECHA_ACEPTACION_REAL`,`X`.`POS_FECHA_ACEPTACION_DESEADA`) AS `13. DIFF: Fecha Aceptacion`,`X`.`POS_SOLICITA_DELIVERY` AS `14. POS Quien Solicita Delivery`,`X`.`POS_TIPO_SOLICITUD` AS `15. POS Tipo Solicitud Delivery`,`X`.`TIEMPO_SOLICITUD_AUTOMATICO` AS `16. POS Tiempo Solicitud Automatico (5, 10 o 15)`,`X`.`POS_FECHA_SOLICITUD_RIDER` AS `17. POS Fecha Solicitud Rider Real`,`X`.`POS_FECHA_SOLICITUD_DESEADA` AS `18. POS Fecha Solicitud Rider Deseada`,timestampdiff(MINUTE,`X`.`POS_FECHA_SOLICITUD_RIDER`,`X`.`POS_FECHA_SOLICITUD_DESEADA`) AS `19. DIFF: Fecha Solicitud Rider`,`X`.`FECHA_PRIMERA_EVIDENCIA_REAL` AS `20. POS Fecha Primera Evidencia Real`,`X`.`FECHA_PRIMERA_EVIDENCIA_DESEADA` AS `21. POS Fecha Primera Evidencia Deseada`,timestampdiff(MINUTE,`X`.`FECHA_PRIMERA_EVIDENCIA_REAL`,`X`.`FECHA_PRIMERA_EVIDENCIA_DESEADA`) AS `22. DIFF: Fecha Primera Evidencia`,`X`.`CANTIDAD_RECHAZOS_RIDER` AS `23. Cantidad Rechazos Rider`,`X`.`PRIMER_RECHAZO` AS `24. Primer Rechazo`,`X`.`ULTIMO_RECHAZO` AS `25. Ultimo Rechazo`,`X`.`CANTIDAD_DESVINCULACION_RIDER` AS `26. Cantidad Desvinculaciones`,`X`.`CODIGO_RIDER` AS `27. Codigo Rider`,`X`.`NOMBRE_RIDER` AS `28. Nombre Rider`,`X`.`TELEFONO_RIDER` AS `29. Telefono Rider`,`X`.`CORREO_RIDER` AS `30. Correo Rider`,`X`.`FECHA_ENTREGA_REAL` AS `31. Fecha Entrega Real`,`X`.`ENTREGA_PROMETIDA` AS `32. Fecha Entrega Deseada`,timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) AS `33. DIFF: Fecha Entrega`,`X`.`DIRECCION_CLIENTE` AS `34. Direccion Cliente`,`X`.`DIRECCION_SUCURSAL` AS `35. Direccion Sucursal Origen`,`X`.`DISTANCIA_KM` AS `36. Distancia KM`,`X`.`MINUTOS_PROMETIDOS` AS `37. Minutos Prometidos`,timestampdiff(MINUTE,`X`.`POS_FECHA_ACEPTACION_REAL`,`X`.`FECHA_ENTREGA_REAL`) AS `38. Minutos Totales`,timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) AS `39. KPI Calidad`,(case when ((timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) < 0) and (timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) >= -(15))) then 'VERDE' when ((timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) < -(16)) and (timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) >= -(30))) then 'AMARILLO' when (timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_REAL`,`X`.`ENTREGA_PROMETIDA`) < -(31)) then 'ROJO' end) AS `40. KPI QOS`,`X`.`ID_CLIENTE` AS `41. ID Cliente`,`X`.`NOMBRE_CLIENTE` AS `42. Nombre Cliente`,`X`.`TELEFONO_CLIENTE` AS `43. Telefono Cliente`,round(`X`.`SUBTOTAL`,0) AS `44. Subtotal`,round(`X`.`PROPINA`,0) AS `45. Propina`,round(`X`.`INGRESO_RIDER`,0) AS `46. Ingreso Total Rider (Incluye propina)`,round(`X`.`COSTO_DELIVERY`,0) AS `47. Costo Delivery`,`X`.`CUPON` AS `48. Cupon`,`X`.`PUNTOS_CANJEADOS` AS `49. Puntos Canjeados`,`X`.`ESTADO_PEDIDO` AS `50. Estado Pedido`,`X`.`ESTADO_PAGO` AS `51. Estado Pago`,`X`.`CALIFICACION_PEDIDO` AS `52. Calificacion Pedido`,`X`.`CALIFICACION_RIDER` AS `53. Calificacion Rider`,`X`.`PEDIDO_COURIER` AS `54. Tipo Rider` from (select `DW`.`IdPedido` AS `ID_PEDIDO`,`DW`.`Codigo` AS `CODIGO`,`DW`.`Correlativo` AS `CORRELATIVO`,`P`.`FechaCreacion` AS `FECHA_CREACION_REAL`,`DW`.`FechaCompraCliente` AS `FECHA_CREACION`,(select `X`.`Tipo` from `delivery`.`pedido_entrega_tipo_entrega` `X` where (`X`.`Id` = `PE`.`TipoEntrega`)) AS `TIPO_ENTREGA`,(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`Fecha`,'+01:00','America/Santiago'),convert_tz(`X`.`Fecha`,'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdPedido` = `DW`.`IdPedido`) and (`X`.`IdTipoSeguimiento` = 3)) limit 1) AS `FECHA_ENTREGA_REAL`,`DW`.`SubtotalProductos` AS `SUBTOTAL`,`DW`.`ComisionDeliveryWebNeto` AS `FEE_DELIVERY`,`DW`.`DeliveryAgilCharge` AS `FEE_DELIVERY_AGIL_CHARGE`,`DW`.`ComisionVentaNeto` AS `FEE_ECOMMERCE`,`DW`.`IdEstadoPedido` AS `ID_ESTADO_PEDIDO`,`DW`.`EstadoPedido` AS `ESTADO_PEDIDO`,`PP`.`IdEstado` AS `ID_ESTADO_PAGO`,`PPE`.`Nombre` AS `ESTADO_PAGO`,`DW`.`IdComercio` AS `ID_COMERCIO`,`DW`.`Comercio` AS `COMERCIO`,`DW`.`IdSucursal` AS `ID_SUCURSAL`,`DW`.`Sucursal` AS `SUCURSAL`,(case when (`PE`.`TipoFechaEntrega` = 1) then 'LO ANTES POSIBLE' when (`PE`.`TipoFechaEntrega` = 3) then 'PROGRAMADO' end) AS `TIPO_FECHA_ENTREGA`,(select concat(`X`.`Nombre`,' ',`X`.`Apellido`) AS `NOMBRE` from `delivery`.`usuario` `X` where (`X`.`IdUsuario` = (select ifnull(`PS`.`IdUsuario`,0) AS `ID_USUARIO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` in (5,13)) and (`PS`.`IdPedido` = `DW`.`IdPedido`)) limit 1))) AS `POS_ACEPTA`,(select (case when (`PS`.`IdTipoSeguimiento` = 5) then 'MANUAL' when (`PS`.`IdTipoSeguimiento` = 13) then 'AUTOMATICO' end) AS `TIPO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` in (5,13)) and (`PS`.`IdPedido` = `DW`.`IdPedido`)) limit 1) AS `POS_TIPO_ACEPTACION`,(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`Fecha`,'+01:00','America/Santiago'),convert_tz(`X`.`Fecha`,'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdTipoSeguimiento` in (5,13)) and (`X`.`IdPedido` = `DW`.`IdPedido`)) order by `X`.`Fecha` limit 1) AS `POS_FECHA_ACEPTACION_REAL`,if(((`PE`.`TipoFechaEntrega` = 1) and ((select (case when (`PS`.`IdTipoSeguimiento` = 5) then 'MANUAL' when (`PS`.`IdTipoSeguimiento` = 13) then 'AUTOMATICO' end) AS `TIPO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` in (5,13)) and (`PS`.`IdPedido` = `DW`.`IdPedido`)) limit 1) = 'AUTOMATICO')),`DW`.`FechaCompraCliente`,(`PE`.`FechaEstimadaEntrega` + interval -((ifnull((select substr(`X`.`Valor`,1,(locate('-',`X`.`Valor`) - 1)) AS `VALOR_MINIMO` from `delivery`.`sucursal_configuracion` `X` where ((`X`.`IdTipoConfiguracion` = 2) and (`X`.`IdSucursal` = `DW`.`IdSucursal`))),10) + ifnull((select substr(`X`.`Valor`,1,(locate('-',`X`.`Valor`) - 1)) AS `VALOR_MINIMO` from `delivery`.`sucursal_configuracion` `X` where ((`X`.`IdTipoConfiguracion` = 3) and (`X`.`IdSucursal` = `DW`.`IdSucursal`))),10))) minute)) AS `POS_FECHA_ACEPTACION_DESEADA`,((select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`FechaEntregaMinima`,'+01:00','America/Santiago'),convert_tz(`X`.`FechaEntregaMinima`,'+00:00','America/Santiago')) from `delivery`.`pedido_preparacion_cocina` `X` where (`X`.`IdPedido` = `DW`.`IdPedido`) limit 1) + interval -(ifnull((select if((`X`.`Valor` = 'manual'),0,`X`.`Valor`) AS `VALOR` from `delivery`.`sucursal_configuracion` `X` where ((`X`.`IdTipoConfiguracion` = 5) and (`X`.`IdSucursal` = `DW`.`IdSucursal`))),0)) minute) AS `POS_FECHA_SOLICITUD_DESEADA`,(select ifnull(`X`.`FechaLlegadaRiderSucursal`,`X`.`FechaRealRetiro`) AS `FECHA` from `delivery`.`pedido_pickup_seguimiento` `X` where (`X`.`IdPedido` = `DW`.`IdPedido`) limit 1) AS `FECHA_PRIMERA_EVIDENCIA_REAL`,(select `X`.`FechaIdealRetiro` AS `FECHA` from `delivery`.`pedido_pickup_seguimiento` `X` where (`X`.`IdPedido` = `DW`.`IdPedido`) limit 1) AS `FECHA_PRIMERA_EVIDENCIA_DESEADA`,(select concat(`X`.`Nombre`,' ',`X`.`Apellido`) AS `NOMBRE` from `delivery`.`usuario` `X` where (`X`.`IdUsuario` = (select ifnull(`PS`.`IdUsuario`,0) AS `ID_USUARIO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` in (6,7,8,9,14)) and (`PS`.`IdPedido` = `DW`.`IdPedido`)) limit 1))) AS `POS_SOLICITA_DELIVERY`,(select (case when (`PS`.`IdTipoSeguimiento` in (6,7,8,9)) then 'MANUAL' when (`PS`.`IdTipoSeguimiento` = 14) then 'AUTOMATICO' end) AS `TIPO` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdPedido` = `DW`.`IdPedido`) and (`PS`.`IdTipoSeguimiento` in (6,7,8,9,14))) limit 1) AS `POS_TIPO_SOLICITUD`,ifnull((select `X`.`Valor` from `delivery`.`sucursal_configuracion` `X` where ((`X`.`IdSucursal` = `DW`.`IdSucursal`) and (`X`.`IdTipoConfiguracion` = 5)) limit 1),10) AS `TIEMPO_SOLICITUD_AUTOMATICO`,ifnull((select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`Fecha`,'+01:00','America/Santiago'),convert_tz(`X`.`Fecha`,'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdPedido` = `DW`.`IdPedido`) and (`X`.`IdTipoSeguimiento` in (6,7,8,9,14))) limit 1),(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(`X`.`Fecha`,'+01:00','America/Santiago'),convert_tz(`X`.`Fecha`,'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdPedido` = `DW`.`IdPedido`) and (`X`.`IdTipoSeguimiento` in (1,4))) order by `X`.`Fecha` limit 1)) AS `POS_FECHA_SOLICITUD_RIDER`,(select count(1) AS `RECHAZOS` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` = 4) and (`PS`.`IdPedido` = `DW`.`IdPedido`))) AS `CANTIDAD_RECHAZOS_RIDER`,(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(min(`X`.`Fecha`),'+01:00','America/Santiago'),convert_tz(min(`X`.`Fecha`),'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdTipoSeguimiento` = 4) and (`X`.`IdPedido` = `DW`.`IdPedido`))) AS `PRIMER_RECHAZO`,(select if(((`P`.`FechaCreacion` >= concat(year(now()),'-04-02 00:00:00')) and (`P`.`FechaCreacion` < concat(year(now()),'-09-02 00:00:00'))),convert_tz(max(`X`.`Fecha`),'+01:00','America/Santiago'),convert_tz(max(`X`.`Fecha`),'+00:00','America/Santiago')) AS `FECHA` from `delivery`.`pedido_seguimiento` `X` where ((`X`.`IdTipoSeguimiento` = 4) and (`X`.`IdPedido` = `DW`.`IdPedido`))) AS `ULTIMO_RECHAZO`,(select count(1) AS `RECHAZOS` from (`delivery`.`pedido_seguimiento` `PS` join `delivery`.`pedido_tipo_seguimiento` `PTS` on((`PTS`.`IdTipoSeguimiento` = `PS`.`IdTipoSeguimiento`))) where ((`PS`.`IdTipoSeguimiento` = 12) and (`PS`.`IdPedido` = `DW`.`IdPedido`))) AS `CANTIDAD_DESVINCULACION_RIDER`,`R`.`Id_Publico` AS `CODIGO_RIDER`,concat(`R`.`Nombre`,' ',`R`.`Apellido`) AS `NOMBRE_RIDER`,`RD`.`Num_Telefono` AS `TELEFONO_RIDER`,`R`.`Mail` AS `CORREO_RIDER`,`PE`.`FechaEstimadaEntrega` AS `ENTREGA_PROMETIDA`,(select `X`.`Direccion` from `delivery`.`usuario_direcciones` `X` where (`X`.`Id` = `DW`.`IdClienteDireccion`)) AS `DIRECCION_CLIENTE`,`S`.`Direccion` AS `DIRECCION_SUCURSAL`,`DW`.`DistanciaClienteTexto` AS `DISTANCIA_KM`,((select ifnull(sum(substr(`SC`.`Valor`,(locate('-',`SC`.`Valor`) + 1),length(`SC`.`Valor`))),20) AS `VALOR` from (`delivery`.`sucursal_configuracion` `SC` left join `delivery`.`sucursal_tipo_configuracion` `STC` on((`STC`.`Id` = `SC`.`IdTipoConfiguracion`))) where ((`STC`.`Id` = 2) and (`SC`.`IdSucursal` = `DW`.`IdSucursal`))) + (select ifnull(sum(substr(`SC`.`Valor`,(locate('-',`SC`.`Valor`) + 1),length(`SC`.`Valor`))),20) AS `VALOR` from (`delivery`.`sucursal_configuracion` `SC` left join `delivery`.`sucursal_tipo_configuracion` `STC` on((`STC`.`Id` = `SC`.`IdTipoConfiguracion`))) where ((`STC`.`Id` = 3) and (`SC`.`IdSucursal` = `DW`.`IdSucursal`)))) AS `MINUTOS_PROMETIDOS`,`U`.`IdUsuario` AS `ID_CLIENTE`,concat(`U`.`Nombre`,' ',`U`.`Apellido`) AS `NOMBRE_CLIENTE`,`U`.`Telefono` AS `TELEFONO_CLIENTE`,`DW`.`PropinaDelivery` AS `PROPINA`,(select `X`.`IngresoTotal` from `delivery`.`rider_facturacion_viajes` `X` where (`X`.`IdPedido` = `DW`.`IdPedido`) limit 1) AS `INGRESO_RIDER`,`DW`.`TotalDeliveryBruto` AS `COSTO_DELIVERY`,`DW`.`Cupon` AS `CUPON`,`DW`.`DsctoPuntos` AS `PUNTOS_CANJEADOS`,(select `PCC`.`Valor` from `delivery`.`pedido_cliente_calificacion` `PCC` where ((`PCC`.`IdPedido` = `DW`.`IdPedido`) and (`PCC`.`IdTipo` >= 1) and (`PCC`.`IdTipo` <= 5)) limit 1) AS `CALIFICACION_PEDIDO`,(select `PCC`.`Valor` from `delivery`.`pedido_cliente_calificacion` `PCC` where ((`PCC`.`IdPedido` = `DW`.`IdPedido`) and (`PCC`.`IdTipo` >= 6) and (`PCC`.`IdTipo` <= 10)) limit 1) AS `CALIFICACION_RIDER`,(select `TCR`.`Nombre` from (`delivery`.`pedido_courier` `PCR` left join `delivery`.`tipo_courier` `TCR` on((`TCR`.`IdCourier` = `PCR`.`IdTipoCourier`))) where (`PCR`.`IdPedido` = `DW`.`IdPedido`) limit 1) AS `PEDIDO_COURIER` from ((((((((`delivery`.`dw_pedido` `DW` left join `delivery`.`pedidos` `P` on((`P`.`IdPedido` = `DW`.`IdPedido`))) left join `delivery`.`pedido_pago` `PP` on((`PP`.`IdPedido` = `DW`.`IdPedido`))) left join `delivery`.`pedido_pago_estado` `PPE` on((`PP`.`IdEstado` = `PPE`.`Id`))) left join `delivery`.`pedido_entrega` `PE` on((`PE`.`IdPedido` = `DW`.`IdPedido`))) left join `delivery`.`rider` `R` on((`R`.`Id_Rider` = `DW`.`IdRider`))) left join `delivery`.`sucursal` `S` on((`S`.`IdSucursal` = `DW`.`IdSucursal`))) left join `delivery`.`usuario` `U` on((`U`.`IdUsuario` = `DW`.`IdCliente`))) left join `delivery`.`rider_dispositivo` `RD` on((`RD`.`Id_Rider` = `R`.`Id_Rider`))) where ((`DW`.`IdEstadoPedido` in (3,8,9,10,11,12)) and (`DW`.`TipoEntrega` = 'Delivery') and (`DW`.`FechaCompraCliente` >= '2022-09-13 00:00:00') and (`DW`.`FechaCompraCliente` < concat(curdate(),' 00:00:00')) and (`DW`.`IdPedidoBase` is not null)) order by `DW`.`IdPedido` desc) `X` order by '1. Comercio','31. Fecha Entrega Real'