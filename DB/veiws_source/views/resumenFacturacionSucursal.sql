CREATE ALGORITHM=UNDEFINED DEFINER=`qa-general`@`%` SQL SECURITY DEFINER VIEW `resumenFacturacionSucursal` AS select `c`.`IdComercio` AS `IdComercio`,`c`.`RazonSocial` AS `Comercio`,`s`.`IdSucursal` AS `IdSucursal`,`s`.`Titulo` AS `Sucursal`,`pfsuc`.`InicioPeriodo` AS `InicioPeriodo`,`pfsuc`.`FinPeriodo` AS `FinPeriodo`,`pfsuc`.`FechaFacturacion` AS `FechaFacturacion`,`facturacion`.`PrimerPedido` AS `PrimerPedido`,`facturacion`.`UltimoPedido` AS `UltimoPedido`,`facturacion`.`Pedidos` AS `Pedidos`,ifnull(`facturacion`.`TotalPedidos`,0) AS `TotalPedidos`,ifnull(`facturacion`.`SubtotalCliente`,0) AS `SubtotalCliente`,ifnull(`facturacion`.`GastosEnvio`,0) AS `GastosEnvio`,ifnull(`facturacion`.`IVAEnvio`,0) AS `IVAEnvio`,ifnull(`facturacion`.`Propina`,0) AS `Propina`,ifnull(`facturacion`.`AbonoCliente`,0) AS `AbonoCliente`,ifnull(`facturacion`.`ComisionPasarelaPago`,0) AS `ComisionPasarelaPago`,ifnull(`facturacion`.`IVAPasarelaPago`,0) AS `IVAPasarelaPago`,ifnull(`facturacion`.`RetencionPasarelaPago`,0) AS `RetencionPasarelaPago`,ifnull(`facturacion`.`IngresoBrutoAgil`,0) AS `IngresoBrutoAgil`,ifnull(`facturacion`.`FeeVenta`,0) AS `FeeVenta`,ifnull(`facturacion`.`ComisionVenta`,0) AS `ComisionVenta`,ifnull(`facturacion`.`IVAComisionVenta`,0) AS `IVAComisionVenta`,ifnull(`facturacion`.`ComisionVentaBruto`,0) AS `ComisionVentaBruto`,ifnull(`facturacion`.`FeeDelivery`,0) AS `FeeDelivery`,ifnull(`facturacion`.`ComisionDelivery`,0) AS `ComisionDelivery`,ifnull(`facturacion`.`IVAComisionDelivery`,0) AS `IVAComisionDelivery`,ifnull(`facturacion`.`ComisionDeliveryBruto`,0) AS `ComisionDeliveryBruto`,ifnull(`facturacion`.`TotalDescuentos`,0) AS `TotalDescuentos`,ifnull(`facturacion`.`NetoComercio`,0) AS `NetoComercio`,`ajustes`.`Ajustes` AS `Ajustes`,ifnull(`ajustes`.`AbonoBruto`,0) AS `AbonosAdicionales`,ifnull(`ajustes`.`CargoBruto`,0) AS `DescuentosAdicionales`,((ifnull(`facturacion`.`NetoComercio`,0) + ifnull(`ajustes`.`AbonoBruto`,0)) - ifnull(`ajustes`.`CargoBruto`,0)) AS `MontoDeposito`,ifnull(`facturacion`.`BrutoAgil`,0) AS `BrutoAgil`,ifnull(`facturacion`.`NetoAgil`,0) AS `NetoAgil`,`bn`.`Nombre` AS `Banco`,`sb`.`IdSucursalBanco` AS `IdSucursalBanco` from ((((((`delivery`.`periodosFacturacionSucursal` `pfsuc` left join `delivery`.`sucursal` `s` on((`s`.`IdSucursal` = `pfsuc`.`IdSucursal`))) left join `delivery`.`comercio` `c` on((`c`.`IdComercio` = `s`.`IdComercio`))) left join `delivery`.`sucursal_banco` `sb` on((`sb`.`IdSucursal` = `s`.`IdSucursal`))) left join `delivery`.`banco` `bn` on((`bn`.`IdBanco` = `sb`.`IdBanco`))) left join (select `dfs`.`IdSucursal` AS `IdSucursal`,`dfs`.`FechaFacturacion` AS `FechaFacturacion`,min(`dfs`.`FechaEntrega`) AS `PrimerPedido`,max(`dfs`.`FechaEntrega`) AS `UltimoPedido`,group_concat(`dfs`.`IdPedidoInterno` separator ',') AS `Pedidos`,count(0) AS `TotalPedidos`,sum(`dfs`.`SubtotalCliente`) AS `SubtotalCliente`,`dfs`.`IVAPais` AS `IVAPais`,sum(`dfs`.`GastosEnvio`) AS `GastosEnvio`,`dfs`.`IVAEnvio` AS `IVAEnvio`,sum(`dfs`.`Propina`) AS `Propina`,sum(`dfs`.`AbonoCliente`) AS `AbonoCliente`,sum(`dfs`.`ComisionPasarelaPago`) AS `ComisionPasarelaPago`,sum(`dfs`.`IVAPasarelaPago`) AS `IVAPasarelaPago`,sum(`dfs`.`RetencionPasarelaPago`) AS `RetencionPasarelaPago`,sum(`dfs`.`IngresoBruto`) AS `IngresoBrutoAgil`,`dfs`.`FeeVenta` AS `FeeVenta`,sum(`dfs`.`ComisionVenta`) AS `ComisionVenta`,sum(`dfs`.`IVAComisionVenta`) AS `IVAComisionVenta`,sum(`dfs`.`ComisionVentaBruto`) AS `ComisionVentaBruto`,`dfs`.`FeeDelivery` AS `FeeDelivery`,sum(`dfs`.`ComisionDelivery`) AS `ComisionDelivery`,sum(`dfs`.`IVAComisionDelivery`) AS `IVAComisionDelivery`,sum(`dfs`.`ComisionDeliveryBruto`) AS `ComisionDeliveryBruto`,sum(`dfs`.`TotalDescuentos`) AS `TotalDescuentos`,sum(`dfs`.`NetoComercio`) AS `NetoComercio`,sum(`dfs`.`BrutoAgil`) AS `BrutoAgil`,sum(`dfs`.`NetoAgil`) AS `NetoAgil` from `delivery`.`detalleFacturacionSucursal` `dfs` group by `dfs`.`IdSucursal`,`dfs`.`FechaFacturacion`) `facturacion` on(((`pfsuc`.`IdSucursal` = `facturacion`.`IdSucursal`) and (`pfsuc`.`FechaFacturacion` = `facturacion`.`FechaFacturacion`)))) left join `delivery`.`resumenAjustesFinancierosSucursal` `ajustes` on(((`pfsuc`.`IdSucursal` = `ajustes`.`IdSucursal`) and (`pfsuc`.`FechaFacturacion` = `ajustes`.`FechaFacturacion`)))) group by `pfsuc`.`IdSucursal`,`pfsuc`.`FechaFacturacion`