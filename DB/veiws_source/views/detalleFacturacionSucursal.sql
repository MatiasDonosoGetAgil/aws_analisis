CREATE ALGORITHM=UNDEFINED DEFINER=`qa-general`@`%` SQL SECURITY DEFINER VIEW `detalleFacturacionSucursal` AS select `p`.`IdPedido` AS `IdPedidoInterno`,`c`.`RazonSocial` AS `Comercio`,`s`.`RazonSocial` AS `Sucursal`,concat('#',`p`.`Codigo`,'-',`p`.`Corelativo`) AS `Codigo`,`p`.`IdEstado` AS `EstadoPedido`,`pe`.`FechaEstimadaEntrega` AS `FechaEntrega`,`p`.`FechaCreacion` AS `FechaCreacion`,`ppr`.`fecha` AS `FechaRespuestaPago`,`p`.`TotalPago` AS `SubtotalCliente`,(`na`.`IVA` / 100) AS `IVAPais`,ifnull((`p`.`DeliveryCharge` + `p`.`DeliveryAgilCharge`),0) AS `GastosEnvio`,ifnull((`p`.`DeliveryCharge` + `p`.`DeliveryAgilCharge`),0) AS `GastosEnvioAux`,ifnull(`p`.`TotalIvaDelivery`,0) AS `IVAEnvio`,(select (`IVAEnvio` + `GastosEnvioAux`)) AS `TotalEnvio`,`p`.`Propina` AS `Propina`,if(isnull(`p`.`IdPedidoBase`),`p`.`Total_OC`,0) AS `AbonoCliente`,if(isnull(`p`.`IdPedidoBase`),`ppr`.`comision`,0) AS `ComisionPasarelaPago`,if(isnull(`p`.`IdPedidoBase`),`ppr`.`impuestos`,0) AS `IVAPasarelaPago`,round((select (`ComisionPasarelaPago` + `IVAPasarelaPago`)),3) AS `RetencionPasarelaPago`,if(isnull(`p`.`IdPedidoBase`),`ppr`.`balance`,0) AS `IngresoBruto`,if(isnull(`p`.`IdPedidoBase`),round((select (`ComisionPasarelaPago` / `AbonoCliente`)),4),0) AS `FeePasarelaPago`,round((select (`FeePasarelaPago` * 100)),3) AS `FeePasarelaPagoPorcentual`,if(isnull(`p`.`IdPedidoBase`),(`cs1`.`Valor` / 100),0) AS `FeeVenta`,if(isnull(`p`.`IdPedidoBase`),`cs1`.`Valor`,0) AS `FeeVentaPorcentual`,round((select (`SubtotalCliente` * `FeeVenta`)),3) AS `ComisionVenta`,round((select (`ComisionVenta` * `IVAPais`)),3) AS `IVAComisionVenta`,round((select (`ComisionVenta` + `IVAComisionVenta`)),3) AS `ComisionVentaBruto`,(`cs2`.`Valor` / 100) AS `FeeDelivery`,`cs2`.`Valor` AS `FeeDeliveryPorcentual`,if((`p`.`TipoEntrega` = 1),round((select (`SubtotalCliente` * `FeeDelivery`)),3),0) AS `ComisionDelivery`,if((`p`.`TipoEntrega` = 1),round((select (`ComisionDelivery` * `IVAPais`)),3),0) AS `IVAComisionDelivery`,round((select (`ComisionDelivery` + `IVAComisionDelivery`)),3) AS `ComisionDeliveryBruto`,round((select ((((`ComisionDeliveryBruto` + `ComisionVentaBruto`) + `p`.`Propina`) + `RetencionPasarelaPago`) + `TotalEnvio`)),3) AS `TotalDescuentos`,round((select (`AbonoCliente` - `TotalDescuentos`)),3) AS `NetoComercio`,round((select (`ComisionDeliveryBruto` + `ComisionVentaBruto`)),3) AS `BrutoAgil`,round((select (`ComisionDelivery` + `ComisionVenta`)),3) AS `NetoAgil`,`s`.`IdSucursal` AS `IdSucursal`,`pfs`.`FechaFacturacion` AS `FechaFacturacion`,`p`.`IdSucursalDeposito` AS `IdSucursalDeposito` from (((((((((((`delivery`.`pedidos` `p` left join `delivery`.`pedido_entrega` `pe` on((`pe`.`IdPedido` = `p`.`IdPedido`))) left join `delivery`.`pedido_pago` `pp` on((`pp`.`IdPedido` = `p`.`IdPedido`))) left join `delivery`.`pedido_pago_respuesta` `ppr` on((`ppr`.`idPago` = `pp`.`IdPago`))) left join `delivery`.`comercio` `c` on((`p`.`IdComercio` = `c`.`IdComercio`))) left join `delivery`.`sucursal` `s` on((`p`.`IdSucursal` = `s`.`IdSucursal`))) left join `delivery`.`comuna` `co` on((`co`.`IdComuna` = `s`.`IdComuna`))) left join `delivery`.`region` `re` on((`re`.`IdRegion` = `co`.`IdRegion`))) left join `delivery`.`nacionalidad` `na` on((`na`.`Id` = `re`.`IdNacionalidad`))) left join `delivery`.`comision_sucursal` `cs1` on(((`cs1`.`IdSucursal` = `s`.`IdSucursal`) and (`cs1`.`IdTipoComision` = 1)))) left join `delivery`.`comision_sucursal` `cs2` on(((`cs2`.`IdSucursal` = `s`.`IdSucursal`) and (`cs2`.`IdTipoComision` = 2)))) left join `delivery`.`periodosFacturacionSucursal` `pfs` on((`pfs`.`IdSucursal` = `s`.`IdSucursal`))) where ((cast(`pe`.`FechaEstimadaEntrega` as date) >= `pfs`.`InicioPeriodo`) and (cast(`pe`.`FechaEstimadaEntrega` as date) <= `pfs`.`FinPeriodo`) and (`p`.`IdEstado` in (8,9,10,11,12)))