CREATE ALGORITHM=UNDEFINED DEFINER=`qa-general`@`%` SQL SECURITY DEFINER VIEW `VW_AnalisisBiAgil` AS select `X`.`Fecha` AS `Fecha`,count(`X`.`Pedido`) AS `CantidadPedidos`,`X`.`Sucursal` AS `Sucursal`,`X`.`EstadoPago` AS `EstadoPago`,`X`.`EstadoPedido` AS `EstadoPedido`,`X`.`TipoEntrega` AS `TipoEntrega`,cast(round(sum(`X`.`Subtotal`),0) as decimal(20,0)) AS `Subtotal`,cast(round(sum(`X`.`DeliveryCharge`),0) as decimal(20,0)) AS `DeliveryCharge`,cast(round(sum(`X`.`DeliveryChargeIva`),0) as decimal(20,0)) AS `DeliveryChargeIva`,cast(round(sum(`X`.`DeliveryAgilCharge`),0) as decimal(20,0)) AS `DeliveryAgilCharge`,cast(round(sum(`X`.`DeliveryAgilChargeIva`),0) as decimal(20,0)) AS `DeliveryAgilChargeIva`,`X`.`IvaPais` AS `IvaPais`,`X`.`RetencionRider` AS `RetencionRider`,cast(round(sum(`X`.`Neto`),0) as decimal(20,0)) AS `Neto`,cast(round(sum(`X`.`Bruto`),0) as decimal(20,0)) AS `Bruto`,cast(round(sum(`X`.`Iva`),0) as decimal(20,0)) AS `Iva`,cast(round(sum(`X`.`GastoEnvio`),0) as decimal(20,0)) AS `GastoEnvio`,cast(round(sum(`X`.`Propina`),0) as decimal(20,0)) AS `Propina`,cast(round(sum(`X`.`PropinaAgilDelivery`),0) as decimal(20,0)) AS `PropinaAgilDelivery`,cast(round(sum(`X`.`PropinaAgilRetiro`),0) as decimal(20,0)) AS `PropinaAgilRetiro`,count(`X`.`CodigoCupon`) AS `CantidadCupones`,cast(round(sum(`X`.`DsctoCuponSubtotal`),0) as decimal(20,0)) AS `DsctoCuponSubtotal`,cast(round(sum(`X`.`DsctoCuponGastoEnvio`),0) as decimal(20,0)) AS `DsctoCuponGastoEnvio`,cast(round(sum(`X`.`DsctoPuntos`),0) as decimal(20,0)) AS `DsctoPuntos`,cast(round(sum(`X`.`TotalBoleta`),0) as decimal(20,0)) AS `TotalBoleta`,cast(round(sum(`X`.`ComisionPagoPorcentaje`),0) as decimal(20,0)) AS `ComisionPagoPorcentaje`,cast(round(sum(`X`.`ComisionPagoNeto`),0) as decimal(20,0)) AS `ComisionPagoNeto`,cast(round(sum(`X`.`ComisionPagoIva`),0) as decimal(20,0)) AS `ComisionPagoIva`,cast(round(sum(`X`.`ComisionPagoBruto`),0) as decimal(20,0)) AS `ComisionPagoBruto`,cast(round(sum(`X`.`ComisionVentaPorcentaje`),0) as decimal(20,0)) AS `ComisionVentaPorcentaje`,cast(round(sum(`X`.`ComisionVentaNeto`),0) as decimal(20,0)) AS `ComisionVentaNeto`,cast(round(sum(`X`.`ComisionVentaIva`),0) as decimal(20,0)) AS `ComisionVentaIva`,cast(round(sum(`X`.`ComisionVentaBruto`),0) as decimal(20,0)) AS `ComisionVentaBruto`,cast(round(sum(`X`.`ComisionDeliveryPorcentaje`),0) as decimal(20,0)) AS `ComisionDeliveryPorcentaje`,cast(round(sum(`X`.`ComisionDeliveryNeto`),0) as decimal(20,0)) AS `ComisionDeliveryNeto`,cast(round(sum(`X`.`ComisionDeliveryIva`),0) as decimal(20,0)) AS `ComisionDeliveryIva`,cast(round(sum(`X`.`ComisionDeliveryBruto`),0) as decimal(20,0)) AS `ComisionDeliveryBruto`,cast(round(sum(`X`.`TotalDescuentos`),0) as decimal(20,0)) AS `TotalDescuentos`,cast(round(sum(`X`.`DepositoComercio`),0) as decimal(20,0)) AS `DepositoComercioSinAjustes`,cast(round(sum(`X`.`TotalComisionesAgil`),0) as decimal(20,0)) AS `TotalComisionesAgil`,cast(round(sum(`X`.`BrutoAgil`),0) as decimal(20,0)) AS `BrutoAgil`,cast(round(sum(`X`.`NetoAgil`),0) as decimal(20,0)) AS `NetoAgil`,cast(round(sum(`X`.`TotalDeliveryIva`),0) as decimal(20,0)) AS `TotalDeliveryIva`,cast(round(sum(`X`.`IngresoAgilNeto`),0) as decimal(20,0)) AS `IngresoAgilNeto`,(cast(round(sum(`X`.`IngresoAgilNeto`),0) as decimal(20,0)) * (`X`.`IvaPais` / 100)) AS `IvaAgil`,((cast(round(sum(`X`.`IngresoAgilNeto`),0) as decimal(20,0)) + cast(round(sum(`X`.`PropinaAgilDelivery`),0) as decimal(20,0))) + cast(round(sum(`X`.`PropinaAgilRetiro`),0) as decimal(20,0))) AS `IncomeAgil` from (select cast(`X`.`FechaEstimadaEntregaMin` as date) AS `Fecha`,`X`.`IdPedido` AS `Pedido`,`X`.`Codigo` AS `Codigo`,`X`.`Comercio` AS `Comercio`,`X`.`Sucursal` AS `Sucursal`,`X`.`EstadoPago` AS `EstadoPago`,`X`.`EstadoPedido` AS `EstadoPedido`,`X`.`TipoEntrega` AS `TipoEntrega`,`X`.`TipoPedido` AS `TipoPedido`,`X`.`EsPedidoHijo` AS `EsPedidoHijo`,`X`.`Subtotal` AS `Subtotal`,`X`.`DeliveryCharge` AS `DeliveryCharge`,`X`.`DeliveryChargeIva` AS `DeliveryChargeIva`,`X`.`DeliveryAgilCharge` AS `DeliveryAgilCharge`,`X`.`DeliveryAgilChargeIva` AS `DeliveryAgilChargeIva`,`X`.`IvaPais` AS `IvaPais`,`X`.`RetencionRider` AS `RetencionRider`,`X`.`Neto` AS `Neto`,`X`.`Iva` AS `Iva`,`X`.`Bruto` AS `Bruto`,`X`.`GastoEnvio` AS `GastoEnvio`,`X`.`Propina` AS `Propina`,`X`.`PropinaAgilDelivery` AS `PropinaAgilDelivery`,`X`.`PropinaAgilRetiro` AS `PropinaAgilRetiro`,`X`.`CodigoCupon` AS `CodigoCupon`,`X`.`DsctoCuponSubtotal` AS `DsctoCuponSubtotal`,`X`.`DsctoCuponGastoEnvio` AS `DsctoCuponGastoEnvio`,`X`.`DsctoPuntos` AS `DsctoPuntos`,`X`.`TotalBoleta` AS `TotalBoleta`,`X`.`MedioPago` AS `MedioPago`,`X`.`ComisionPagoPorcentaje` AS `ComisionPagoPorcentaje`,`X`.`ComisionPagoNeto` AS `ComisionPagoNeto`,`X`.`ComisionPagoIva` AS `ComisionPagoIva`,`X`.`ComisionPagoBruto` AS `ComisionPagoBruto`,`X`.`ComisionVentaPorcentaje` AS `ComisionVentaPorcentaje`,`X`.`ComisionVentaNeto` AS `ComisionVentaNeto`,`X`.`ComisionVentaIva` AS `ComisionVentaIva`,`X`.`ComisionVentaBruto` AS `ComisionVentaBruto`,`X`.`ComisionDeliveryPorcentaje` AS `ComisionDeliveryPorcentaje`,`X`.`ComisionDeliveryNeto` AS `ComisionDeliveryNeto`,`X`.`ComisionDeliveryIva` AS `ComisionDeliveryIva`,`X`.`ComisionDeliveryBruto` AS `ComisionDeliveryBruto`,`X`.`TotalDescuentos` AS `TotalDescuentos`,`X`.`DepositoComercio` AS `DepositoComercio`,`X`.`TotalComisionesAgil` AS `TotalComisionesAgil`,`X`.`BrutoAgil` AS `BrutoAgil`,`X`.`NetoAgil` AS `NetoAgil`,`X`.`TotalDeliveryIva` AS `TotalDeliveryIva`,((ifnull(`X`.`ComisionVentaNeto`,0) + ifnull(`X`.`ComisionDeliveryNeto`,0)) + ifnull(`X`.`DeliveryAgilCharge`,0)) AS `IngresoAgilNeto` from `delivery`.`dw_base_financiera` `X` where (((`X`.`EsPedidoHijo` = 'SI') or ((`X`.`EsPedidoHijo` = 'NO') and (`X`.`EstadoPago` in ('Activo','Reembolsado')))) and (`X`.`CodigoTipoPedido` = 'PEDNORMAL'))) `X` group by `X`.`Fecha`,`X`.`Sucursal`,`X`.`EstadoPago`,`X`.`EstadoPedido`,`X`.`TipoEntrega`,`X`.`EsPedidoHijo`,`X`.`IvaPais`,`X`.`RetencionRider`,`X`.`MedioPago`