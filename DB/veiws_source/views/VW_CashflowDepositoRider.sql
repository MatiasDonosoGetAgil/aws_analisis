CREATE ALGORITHM=UNDEFINED DEFINER=`qa-general`@`%` SQL SECURITY DEFINER VIEW `VW_CashflowDepositoRider` AS select `X`.`DiaDepositoRider` AS `DiaDepositoRider`,sum(`X`.`CantidadPedidos`) AS `CantidadPedidos`,count(distinct `X`.`IdRider`) AS `CantidadRiders`,cast(round(sum(`X`.`PropinaRider`),0) as decimal(20,0)) AS `PropinaRider`,cast(round(sum(`X`.`IngresoNetoRider`),0) as decimal(20,0)) AS `IngresoNetoBase`,cast(round(sum(`X`.`IngresoBrutoRider`),0) as decimal(20,0)) AS `IngresoBrutoBase`,cast(round(sum(`X`.`RetencionHonorarioRider`),0) as decimal(20,0)) AS `RetencionHonorarioBase`,cast(round(sum(`X`.`DepositoRiderSinBonos`),0) as decimal(20,0)) AS `DepositoRiderSinBonos`,cast(round(sum(`X`.`NetoBonos`),0) as decimal(20,0)) AS `IngresoNetoBonos`,cast(round(sum(`X`.`MontoBrutoBonos`),0) as decimal(20,0)) AS `IngresoBrutoBonos`,cast(round(sum(`X`.`RetencionHonorariosBonos`),0) as decimal(20,0)) AS `RetencionHonorariosBonos`,cast(round(sum(`X`.`NetoBonos`),0) as decimal(20,0)) AS `DepositoRiderBonos`,cast(round(sum(`X`.`IngresoNetoTotal`),0) as decimal(20,0)) AS `IngresoNetoTotal`,cast(round(sum(`X`.`IngresoBrutoTotal`),0) as decimal(20,0)) AS `IngresoBrutoTotal`,cast(round(sum(`X`.`RetencionHonorariosTotal`),0) as decimal(20,0)) AS `RetencionHonorariosTotal`,cast(round(sum(`X`.`DepositoRider`),0) as decimal(20,0)) AS `DepositoRider` from (select `X`.`DiaDepositoRider` AS `DiaDepositoRider`,count(`X`.`IdPedido`) AS `CantidadPedidos`,`X`.`IdRider` AS `IdRider`,`X`.`IdPublicoRider` AS `IdPublicoRider`,`X`.`DniRider` AS `DniRider`,`X`.`NombreRider` AS `NombreRider`,`X`.`ApellidoRider` AS `ApellidoRider`,`X`.`CorreoRider` AS `CorreoRider`,`X`.`PeriodoFacturacionInicioRider` AS `PeriodoFacturacionInicioRider`,`X`.`PeriodoFacturacionFinRider` AS `PeriodoFacturacionFinRider`,sum(ifnull(`X`.`TarifaBaseRider`,0)) AS `TarifaBaseRider`,sum(ifnull(`X`.`IngresoExtraRider`,0)) AS `IngresoExtraRider`,sum(ifnull(`X`.`PropinaRider`,0)) AS `PropinaRider`,sum(ifnull(`X`.`TotalOfertaRider`,0)) AS `TotalOfertaRider`,sum(ifnull(`X`.`IngresoNetoRider`,0)) AS `IngresoNetoRider`,sum(ifnull(`X`.`RetencionHonorarioRider`,0)) AS `RetencionHonorarioRider`,sum(ifnull(`X`.`IngresoBrutoRider`,0)) AS `IngresoBrutoRider`,(sum(ifnull(`X`.`TotalOfertaRider`,0)) - sum(ifnull(`X`.`RetencionHonorarioRider`,0))) AS `DepositoRiderSinBonos`,ifnull(`BONO`.`Cantidad`,0) AS `CantidadBonos`,(ifnull(`BONO`.`MontoBruto`,0) - (ifnull(`BONO`.`MontoBruto`,0) * (`X`.`RetencionRider` / 100))) AS `NetoBonos`,(ifnull(`BONO`.`MontoBruto`,0) * (`X`.`RetencionRider` / 100)) AS `RetencionHonorariosBonos`,ifnull(`BONO`.`MontoBruto`,0) AS `MontoBrutoBonos`,(sum(ifnull(`X`.`IngresoNetoRider`,0)) + (ifnull(`BONO`.`MontoBruto`,0) - (ifnull(`BONO`.`MontoBruto`,0) * (`X`.`RetencionRider` / 100)))) AS `IngresoNetoTotal`,(sum(ifnull(`X`.`RetencionHonorarioRider`,0)) + (ifnull(`BONO`.`MontoBruto`,0) * (`X`.`RetencionRider` / 100))) AS `RetencionHonorariosTotal`,(sum(ifnull(`X`.`IngresoBrutoRider`,0)) + ifnull(`BONO`.`MontoBruto`,0)) AS `IngresoBrutoTotal`,((sum(ifnull(`X`.`TotalOfertaRider`,0)) - sum(ifnull(`X`.`RetencionHonorarioRider`,0))) + (ifnull(`BONO`.`MontoBruto`,0) - (ifnull(`BONO`.`MontoBruto`,0) * (`X`.`RetencionRider` / 100)))) AS `DepositoRider` from (`delivery`.`dw_base_financiera` `X` left join (select `R`.`IdRider` AS `IdRider`,count(`R`.`IdBonoDesafio`) AS `Cantidad`,date_format(`R`.`FechaPremio`,'%Y-%m-%d') AS `Fecha`,sum(`B`.`PremioMonto`) AS `MontoBruto` from (`delivery`.`rider_bono` `R` join `delivery`.`bono_desafio` `B` on((`R`.`IdBonoDesafio` = `B`.`IdBonoDesafio`))) where ((`B`.`IdTipoPremio` = 1) and (`R`.`IdEstado` in (3,5))) group by `R`.`IdRider`,date_format(`R`.`FechaPremio`,'%Y-%m-%d')) `BONO` on(((`BONO`.`IdRider` = `X`.`IdRider`) and (`BONO`.`Fecha` >= `X`.`PeriodoFacturacionInicioRider`) and (`BONO`.`Fecha` <= `X`.`PeriodoFacturacionFinRider`)))) where ((`X`.`DiaDepositoRider` is not null) and (`X`.`IdRider` is not null)) group by `X`.`DiaDepositoRider`,`X`.`IdRider`,`X`.`IdPublicoRider`,`X`.`DniRider`,`X`.`NombreRider`,`X`.`ApellidoRider`,`X`.`CorreoRider`,`X`.`PeriodoFacturacionInicioRider`,`X`.`PeriodoFacturacionFinRider`) `X` group by `X`.`DiaDepositoRider` order by `X`.`DiaDepositoRider` desc