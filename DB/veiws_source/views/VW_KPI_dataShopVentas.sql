CREATE ALGORITHM=UNDEFINED DEFINER=`qa-general`@`%` SQL SECURITY DEFINER VIEW `VW_KPI_dataShopVentas` AS select `X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`FECHA_ENTREGA` AS `FECHA_ENTREGA`,`X`.`CODIGO` AS `CODIGO`,`X`.`CORRELATIVO` AS `CORRELATIVO`,`X`.`SUBTOTAL` AS `SUBTOTAL`,round(((`X`.`FEE_DELIVERY` + `X`.`FEE_DELIVERY_AGIL_CHARGE`) + `X`.`FEE_ECOMMERCE`),0) AS `NETO_AGIL`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`ESTADO_PAGO` AS `ESTADO_PAGO`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA` from (select `DW`.`IdPedido` AS `ID_PEDIDO`,`DW`.`Codigo` AS `CODIGO`,`DW`.`Correlativo` AS `CORRELATIVO`,`DW`.`FechaCompraCliente` AS `FECHA_PAGO`,`DW`.`FechaEntrega` AS `FECHA_ENTREGA`,`DW`.`TipoEntrega` AS `TIPO_ENTREGA`,`DW`.`SubtotalProductos` AS `SUBTOTAL`,`DW`.`ComisionDeliveryWebNeto` AS `FEE_DELIVERY`,`DW`.`DeliveryAgilCharge` AS `FEE_DELIVERY_AGIL_CHARGE`,`DW`.`ComisionVentaNeto` AS `FEE_ECOMMERCE`,`DW`.`IdEstadoPedido` AS `ID_ESTADO_PEDIDO`,`DW`.`EstadoPedido` AS `ESTADO_PEDIDO`,`PP`.`IdEstado` AS `ID_ESTADO_PAGO`,`PPE`.`Nombre` AS `ESTADO_PAGO`,`DW`.`IdComercio` AS `ID_COMERCIO`,`DW`.`Comercio` AS `COMERCIO`,`DW`.`IdSucursal` AS `ID_SUCURSAL`,`DW`.`Sucursal` AS `SUCURSAL`,(case when (`PE`.`TipoFechaEntrega` = 1) then 'LO ANTES POSIBLE' when (`PE`.`TipoFechaEntrega` = 3) then 'PROGRAMADO' end) AS `TIPO_FECHA_ENTREGA` from (((`delivery`.`dw_pedido` `DW` left join `delivery`.`pedido_pago` `PP` on((`PP`.`IdPedido` = `DW`.`IdPedido`))) left join `delivery`.`pedido_pago_estado` `PPE` on((`PP`.`IdEstado` = `PPE`.`Id`))) left join `delivery`.`pedido_entrega` `PE` on((`PE`.`IdPedido` = `DW`.`IdPedido`))) where ((`DW`.`IdEstadoPedido` in (1,8,9,10,11,12)) and (`PPE`.`Id` in (1,16)) and (`DW`.`FechaCompraCliente` >= date_format((curdate() + interval -(3) month),'%Y-%m-01 00:00:00')) and (`DW`.`FechaCompraCliente` < concat(curdate(),' 00:00:00'))) order by `DW`.`IdPedido` desc) `X` order by `X`.`COMERCIO`,`X`.`FECHA_PAGO`