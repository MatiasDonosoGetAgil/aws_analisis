CREATE ALGORITHM=UNDEFINED DEFINER=`qa-general`@`%` SQL SECURITY DEFINER VIEW `VW_TiemposEnvios` AS select `X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,`X`.`PEDIDO` AS `PEDIDO`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`FECHA_ENTREGA_MIN` AS `FECHA_ENTREGA_MIN`,date_format(`X`.`FECHA_ENTREGA_MIN`,'%Y-%m-%d') AS `DIA_FECHA_ENTREGA`,`X`.`ID_RIDER` AS `ID_RIDER`,`X`.`RIDER` AS `RIDER`,`X`.`COURIER` AS `COURIER`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`DESVINCULACION_FORZOSA` AS `DESVINCULACION_FORZOSA`,`X`.`CIERRE_FORZOSO` AS `CIERRE_FORZOSO`,`X`.`TIPO_ACEPTACION` AS `TIPO_ACEPTACION`,`X`.`ENTREGA_MODIFICADA` AS `ENTREGA_MODIFICADA`,`X`.`FECHA_ESTIMADA_ACEPTACION_POS` AS `FECHA_ESTIMADA_ACEPTACION_POS`,`X`.`FECHA_ACEPTACION_POS` AS `FECHA_REAL_ACEPTACION_POS`,`X`.`DIFF_ACEPTACION_MINUTOS` AS `DIFF_ACEPTACION_POS`,(case when (`X`.`DIFF_ACEPTACION_MINUTOS` < 1) then '0' when (`X`.`DIFF_ACEPTACION_MINUTOS` <= 5) then '1-5' when (`X`.`DIFF_ACEPTACION_MINUTOS` > 5) then '5+' end) AS `KPI_TIEMPO_ACEPTACION_POS`,`X`.`TIEMPO_COCINA_COMPLETO` AS `TIEMPO_COCINA`,`X`.`SALIDA_COCINA` AS `FECHA_ESTIMADA_MIN_SALIDA_COCINA`,`X`.`SALIDA_COCINA_REAL` AS `FECHA_REAL_SALIDA_COCINA`,`X`.`DIFF_SALIDA_COCINA` AS `DIFF_SALIDA_MIN_COCINA`,(case when (`X`.`DIFF_SALIDA_COCINA` <= 5) then '0-5' when (`X`.`DIFF_SALIDA_COCINA` <= 10) then '6-10' when (`X`.`DIFF_SALIDA_COCINA` > 10) then '10+' end) AS `KPI_SALIDA_COCINA`,`X`.`TIPO_SOLICITUD` AS `TIPO_SOLICITUD_RIDER`,`X`.`TIPO_SOLICITUD_CONFIGURACION` AS `TIPO_CONFIGURACION`,`X`.`SALIDA_COCINA` AS `FECHA_ESTIMADA_SOLICITUD_RIDER`,`X`.`FECHA_SOLICITUD_DELIVERY` AS `FECHA_REAL_SOLICITUD_RIDER`,`X`.`DIFF_SOLICITUD_RIDER` AS `DIFF_SOLICITUD_RIDER`,(case when (`X`.`DIFF_SOLICITUD_RIDER` <= 10) then '0-10' when (`X`.`DIFF_SOLICITUD_RIDER` <= 15) then '11-15' when (`X`.`DIFF_SOLICITUD_RIDER` > 15) then '15+' end) AS `KPI_SOLICITUD_RIDER`,`X`.`FECHA_SOLICITUD_DELIVERY` AS `FECHA_SOLICITUD_RIDER`,`X`.`ACEPTACION_ULTIMO_RIDER` AS `FECHA_ACEPTACION_RIDER`,`X`.`DIFF_ACEPTACION_RIDER` AS `DIFF_ACEPTA_OFERTA`,(case when (`X`.`DIFF_ACEPTACION_RIDER` <= 5) then '0-5' when (`X`.`DIFF_ACEPTACION_RIDER` <= 10) then '6-10' when (`X`.`DIFF_ACEPTACION_RIDER` > 10) then '10+' end) AS `KPI_ACEPTA_OFERTA`,`X`.`RIDER_TIEMPO_DISTANCIA_SUCURSAL` AS `TIEMPO_DISTANCIA_SUCURSAL`,`X`.`SALIDA_COCINA` AS `FECHA_ESTIMADA_LLEGADA_RIDER_SUCURSAL`,`X`.`FECHA_LLEGADA_RIDER_SUCURSAL` AS `FECHA_REAL_LLEGADA_RIDER_SUCURSAL`,`X`.`DIFF_LLEGADA_RIDER_SUCURSAL` AS `DIFF_ACEPTACION_LLEGADA_RIDER_SUCURSAL`,`X`.`DIFF_LLEGADA_RIDER_OPTIMA` AS `DIFF_LLEGADA_RIDER_SUCURSAL`,(case when (`X`.`DIFF_LLEGADA_RIDER_OPTIMA` <= 5) then '0-5' when (`X`.`DIFF_LLEGADA_RIDER_OPTIMA` <= 10) then '6-10' when (`X`.`DIFF_LLEGADA_RIDER_OPTIMA` > 10) then '10+' end) AS `KPI_LLEGADA_RIDER_SUCURSAL`,`X`.`SALIDA_COCINA` AS `FECHA_ESTIMADA_DESPACHO`,`X`.`FECHA_LLEGADA_RIDER_SUCURSAL` AS `FECHA_LLEGADA_RIDER_SUCURSAL`,`X`.`FECHA_PRIMERA_EVIDENCIA` AS `FECHA_PRIMERA_EVIDENCIA`,`X`.`DIFF_ESPERA_EN_SUCURSAL` AS `DIFF_ESPERA_EN_SUCURSAL`,(case when (`X`.`DIFF_ESPERA_EN_SUCURSAL` <= 5) then '0-5' when (`X`.`DIFF_ESPERA_EN_SUCURSAL` > 5) then '5+' end) AS `KPI_ESPERA_EN_SUCURSAL`,`X`.`FECHA_ENTREGA_MIN` AS `FECHA_ESTIMADA_ENTREGA`,`X`.`RIDER_TIEMPO_DISTANCIA_DOMICILIO` AS `RIDER_TIEMPO_DISTANCIA_DOMICILIO`,`X`.`FECHA_LLEGADA_RIDER_DOMICILIO` AS `FECHA_LLEGADA_RIDER_DOMICILIO`,`X`.`DIFF_RIDER_AL_DOMICILIO_OPTIMA` AS `DIFF_ENTREGA_OPTIMA`,`X`.`DIFF_RIDER_AL_DOMICILIO` AS `DIFF_RIDER_AL_DOMICILIO`,(case when (`X`.`DIFF_RIDER_AL_DOMICILIO` <= 5) then '0-5' when (`X`.`DIFF_RIDER_AL_DOMICILIO` <= 10) then '6-10' when (`X`.`DIFF_RIDER_AL_DOMICILIO` > 10) then '10+' end) AS `KPI_RIDER_AL_DOMICILIO`,`X`.`FECHA_SEGUNDA_EVIDENCIA` AS `FECHA_SEGUNDA_EVIDENCIA`,`X`.`DIFF_RIDER_AL_CIERRE` AS `DIFF_ENTREGA`,(case when (`X`.`DIFF_RIDER_AL_CIERRE` <= 5) then '0-5' when (`X`.`DIFF_RIDER_AL_CIERRE` > 5) then '5+' end) AS `KPI_ENTREGA`,`X`.`DIFF_ENTREGA_REAL_ENTREGA_MINIMA` AS `DIFF_ENTREGA_REAL_ENTREGA_MINIMA` from (select `X`.`TIEMPO_DELIVERY_MIN` AS `TIEMPO_DELIVERY_MIN`,`X`.`TIEMPO_DELIVERY_MAX` AS `TIEMPO_DELIVERY_MAX`,`X`.`TIEMPO_COCINA_MIN` AS `TIEMPO_COCINA_MIN`,`X`.`TIEMPO_COCINA_MAX` AS `TIEMPO_COCINA_MAX`,`X`.`TIEMPO_COCINA_COMPLETO` AS `TIEMPO_COCINA_COMPLETO`,`X`.`FECHA_ENTREGA_MIN` AS `FECHA_ENTREGA_MIN`,`X`.`FECHA_ENTREGA_MAX` AS `FECHA_ENTREGA_MAX`,`X`.`SALIDA_COCINA_REAL` AS `SALIDA_COCINA_REAL`,`X`.`FECHA_ACEPTACION_POS` AS `FECHA_ACEPTACION_POS`,`X`.`TIPO_ACEPTACION` AS `TIPO_ACEPTACION`,`X`.`TIPO_SOLICITUD` AS `TIPO_SOLICITUD`,`X`.`TIPO_SOLICITUD_CONFIGURACION` AS `TIPO_SOLICITUD_CONFIGURACION`,`X`.`PEDIDO` AS `PEDIDO`,`X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`FECHA_INGRESO_POS` AS `FECHA_INGRESO_POS`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA_ID` AS `TIPO_FECHA_ENTREGA_ID`,`X`.`ENTREGA_MODIFICADA` AS `ENTREGA_MODIFICADA`,`X`.`ACEPTACION_ULTIMO_RIDER` AS `ACEPTACION_ULTIMO_RIDER`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`FECHA_SOLICITUD_DELIVERY` AS `FECHA_SOLICITUD_DELIVERY`,`X`.`FECHA_PRIMERA_EVIDENCIA` AS `FECHA_PRIMERA_EVIDENCIA`,`X`.`FECHA_SEGUNDA_EVIDENCIA` AS `FECHA_SEGUNDA_EVIDENCIA`,`X`.`COURIER` AS `COURIER`,`X`.`ES_LLAVE_AGIL` AS `ES_LLAVE_AGIL`,`X`.`ID_RIDER` AS `ID_RIDER`,`X`.`RIDER` AS `RIDER`,`X`.`FECHA_LLEGADA_RIDER_SUCURSAL` AS `FECHA_LLEGADA_RIDER_SUCURSAL`,`X`.`FECHA_LLEGADA_RIDER_DOMICILIO` AS `FECHA_LLEGADA_RIDER_DOMICILIO`,`X`.`RIDER_TIEMPO_DISTANCIA_SUCURSAL` AS `RIDER_TIEMPO_DISTANCIA_SUCURSAL`,`X`.`RIDER_TIEMPO_DISTANCIA_DOMICILIO` AS `RIDER_TIEMPO_DISTANCIA_DOMICILIO`,`X`.`DESVINCULACION_FORZOSA` AS `DESVINCULACION_FORZOSA`,`X`.`CIERRE_FORZOSO` AS `CIERRE_FORZOSO`,`X`.`SALIDA_COCINA` AS `SALIDA_COCINA`,`X`.`ES_EXPRESS` AS `ES_EXPRESS`,`X`.`FECHA_ESTIMADA_ACEPTACION_POS` AS `FECHA_ESTIMADA_ACEPTACION_POS`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,timestampdiff(MINUTE,`X`.`FECHA_ESTIMADA_ACEPTACION_POS`,`X`.`FECHA_ACEPTACION_POS`) AS `DIFF_ACEPTACION_MINUTOS`,timestampdiff(MINUTE,`X`.`FECHA_SOLICITUD_DELIVERY`,`X`.`ACEPTACION_ULTIMO_RIDER`) AS `DIFF_ACEPTACION_RIDER`,timestampdiff(MINUTE,`X`.`SALIDA_COCINA`,`X`.`SALIDA_COCINA_REAL`) AS `DIFF_SALIDA_COCINA`,timestampdiff(MINUTE,`X`.`SALIDA_COCINA`,`X`.`FECHA_SOLICITUD_DELIVERY`) AS `DIFF_SOLICITUD_RIDER`,timestampdiff(MINUTE,`X`.`ACEPTACION_ULTIMO_RIDER`,`X`.`FECHA_LLEGADA_RIDER_SUCURSAL`) AS `DIFF_LLEGADA_RIDER_SUCURSAL`,timestampdiff(MINUTE,`X`.`FECHA_LLEGADA_RIDER_SUCURSAL`,`X`.`FECHA_PRIMERA_EVIDENCIA`) AS `DIFF_ESPERA_EN_SUCURSAL`,timestampdiff(MINUTE,`X`.`FECHA_PRIMERA_EVIDENCIA`,`X`.`FECHA_LLEGADA_RIDER_DOMICILIO`) AS `DIFF_RIDER_AL_DOMICILIO`,timestampdiff(MINUTE,`X`.`FECHA_LLEGADA_RIDER_DOMICILIO`,`X`.`FECHA_SEGUNDA_EVIDENCIA`) AS `DIFF_RIDER_AL_CIERRE`,timestampdiff(MINUTE,`X`.`SALIDA_COCINA`,`X`.`FECHA_LLEGADA_RIDER_SUCURSAL`) AS `DIFF_LLEGADA_RIDER_OPTIMA`,timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_MIN`,`X`.`FECHA_LLEGADA_RIDER_DOMICILIO`) AS `DIFF_RIDER_AL_DOMICILIO_OPTIMA`,timestampdiff(MINUTE,`X`.`FECHA_ENTREGA_MIN`,`X`.`FECHA_SEGUNDA_EVIDENCIA`) AS `DIFF_ENTREGA_REAL_ENTREGA_MINIMA` from (select `X`.`TIEMPO_DELIVERY_MIN` AS `TIEMPO_DELIVERY_MIN`,`X`.`TIEMPO_DELIVERY_MAX` AS `TIEMPO_DELIVERY_MAX`,`X`.`TIEMPO_COCINA_MIN` AS `TIEMPO_COCINA_MIN`,`X`.`TIEMPO_COCINA_MAX` AS `TIEMPO_COCINA_MAX`,`X`.`TIEMPO_COCINA_COMPLETO` AS `TIEMPO_COCINA_COMPLETO`,`X`.`FECHA_ENTREGA_MIN` AS `FECHA_ENTREGA_MIN`,`X`.`FECHA_ENTREGA_MAX` AS `FECHA_ENTREGA_MAX`,`X`.`SALIDA_COCINA_REAL` AS `SALIDA_COCINA_REAL`,`X`.`FECHA_ACEPTACION_POS` AS `FECHA_ACEPTACION_POS`,`X`.`TIPO_ACEPTACION` AS `TIPO_ACEPTACION`,`X`.`TIPO_SOLICITUD` AS `TIPO_SOLICITUD`,`X`.`TIPO_SOLICITUD_CONFIGURACION` AS `TIPO_SOLICITUD_CONFIGURACION`,`X`.`PEDIDO` AS `PEDIDO`,`X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,`X`.`FECHA_CREACION` AS `FECHA_CREACION`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`FECHA_INGRESO_POS` AS `FECHA_INGRESO_POS`,`X`.`TIPO_FECHA_ENTREGA_ID` AS `TIPO_FECHA_ENTREGA_ID`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`ENTREGA_MODIFICADA` AS `ENTREGA_MODIFICADA`,`X`.`ACEPTACION_ULTIMO_RIDER` AS `ACEPTACION_ULTIMO_RIDER`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`FECHA_SOLICITUD_DELIVERY` AS `FECHA_SOLICITUD_DELIVERY`,`X`.`FECHA_PRIMERA_EVIDENCIA` AS `FECHA_PRIMERA_EVIDENCIA`,`X`.`FECHA_SEGUNDA_EVIDENCIA` AS `FECHA_SEGUNDA_EVIDENCIA`,`X`.`COURIER` AS `COURIER`,`X`.`ES_LLAVE_AGIL` AS `ES_LLAVE_AGIL`,`X`.`ID_RIDER` AS `ID_RIDER`,`X`.`RIDER` AS `RIDER`,`X`.`FECHA_LLEGADA_RIDER_SUCURSAL` AS `FECHA_LLEGADA_RIDER_SUCURSAL`,`X`.`FECHA_LLEGADA_RIDER_DOMICILIO` AS `FECHA_LLEGADA_RIDER_DOMICILIO`,`X`.`RIDER_TIEMPO_DISTANCIA_SUCURSAL` AS `RIDER_TIEMPO_DISTANCIA_SUCURSAL`,`X`.`RIDER_TIEMPO_DISTANCIA_DOMICILIO` AS `RIDER_TIEMPO_DISTANCIA_DOMICILIO`,`X`.`DESVINCULACION_FORZOSA` AS `DESVINCULACION_FORZOSA`,`X`.`CIERRE_FORZOSO` AS `CIERRE_FORZOSO`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`SALIDA_COCINA` AS `SALIDA_COCINA`,if((`X`.`TIPO_FECHA_ENTREGA_ID` = 1),'SI','NO') AS `ES_EXPRESS`,(case when (`X`.`TIPO_FECHA_ENTREGA_ID` = 1) then (`X`.`FECHA_PAGO` + interval 5 second) else (concat(date_format(`X`.`FECHA_ENTREGA_MIN`,'%Y-%m-%d'),' ',date_format(`X`.`SALIDA_COCINA`,'%H:%i:00')) - interval `X`.`TIEMPO_COCINA_MIN` minute) end) AS `FECHA_ESTIMADA_ACEPTACION_POS` from (select substring_index(`PT`.`TiempoDelivery`,'-',1) AS `TIEMPO_DELIVERY_MIN`,substring_index(`PT`.`TiempoDelivery`,'-',-(1)) AS `TIEMPO_DELIVERY_MAX`,substring_index(`PT`.`TiempoCocina`,'-',1) AS `TIEMPO_COCINA_MIN`,substring_index(`PT`.`TiempoCocina`,'-',-(1)) AS `TIEMPO_COCINA_MAX`,if((`PT`.`TiempoCocina` = '1-11'),'hasta 10',`PT`.`TiempoCocina`) AS `TIEMPO_COCINA_COMPLETO`,date_format(convert_tz(`PT`.`FechaEstimadaEntregaMin`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_ENTREGA_MIN`,date_format(convert_tz(`PT`.`FechaEstimadaEntregaMax`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_ENTREGA_MAX`,date_format(convert_tz(`PT`.`FechaSalidaCocina`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `SALIDA_COCINA_REAL`,date_format(convert_tz(`PT`.`FechaAceptacionPos`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_ACEPTACION_POS`,ifnull(`PT`.`TipoAceptacion`,'') AS `TIPO_ACEPTACION`,ifnull(`PT`.`TipoSolicitudDelivery`,'') AS `TIPO_SOLICITUD`,ifnull(`SC`.`Valor`,'manual') AS `TIPO_SOLICITUD_CONFIGURACION`,concat_ws('-',`P`.`Codigo`,`P`.`Corelativo`) AS `PEDIDO`,`C`.`Nombre` AS `COMERCIO`,`S`.`Titulo` AS `SUCURSAL`,date_format(`P`.`FechaCreacion`,'%Y-%m-%d %H:%i:%s') AS `FECHA_CREACION`,date_format(convert_tz(`PT`.`FechaPago`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_PAGO`,date_format(convert_tz(`PT`.`FechaIngresoPos`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_INGRESO_POS`,`PE`.`TipoFechaEntrega` AS `TIPO_FECHA_ENTREGA_ID`,`TFE`.`Tipo` AS `TIPO_FECHA_ENTREGA`,ifnull(replace(replace(`PCE`.`Valor`,'Se Cambio la fecha de entrega para el ',''),'Se agrego ',''),'') AS `ENTREGA_MODIFICADA`,date_format(convert_tz(`PT`.`FechaUltimaAceptacionRider`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `ACEPTACION_ULTIMO_RIDER`,if((`P`.`TipoEntrega` = 1),'DELIVERY','RETIRO') AS `TIPO_ENTREGA`,date_format(convert_tz(`PT`.`FechaSolicitudDelivery`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_SOLICITUD_DELIVERY`,date_format(convert_tz(ifnull(`PT`.`FechaPrimeraEvidencia`,`PSS`.`Fecha`),'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_PRIMERA_EVIDENCIA`,date_format(convert_tz(ifnull(`PT`.`FechaSegundaEvidencia`,`PSC`.`Fecha`),'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_SEGUNDA_EVIDENCIA`,ifnull(`TC`.`Nombre`,'AGIL') AS `COURIER`,if((`PR`.`EsAgil` = 1),'SI','NO') AS `ES_LLAVE_AGIL`,ifnull(`R`.`Id_Publico`,'') AS `ID_RIDER`,concat(ifnull(`R`.`Nombre`,''),' ',ifnull(`R`.`Apellido`,'')) AS `RIDER`,date_format(convert_tz(`PT`.`FechaLLegadaRiderSucursal`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_LLEGADA_RIDER_SUCURSAL`,date_format(convert_tz(`PT`.`FechaLLegadaRiderDomicilio`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `FECHA_LLEGADA_RIDER_DOMICILIO`,ifnull(`PSD`.`RiderInitDuracionTexto`,'') AS `RIDER_TIEMPO_DISTANCIA_SUCURSAL`,ifnull(`PSD`.`SucursalInitDuracionTexto`,'') AS `RIDER_TIEMPO_DISTANCIA_DOMICILIO`,ifnull(`PT`.`FechaUltimaDisvinculacionRider`,'') AS `DESVINCULACION_FORZOSA`,ifnull(`PT`.`FechaCierreForzoso`,'') AS `CIERRE_FORZOSO`,`PES`.`Nombre` AS `ESTADO_PEDIDO`,date_format(convert_tz(`PC`.`FechaEntregaMinima`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d %H:%i:%s') AS `SALIDA_COCINA` from (((((((((((((((((`delivery`.`pedido_tiempo` `PT` join `delivery`.`pedido_preparacion_cocina` `PC` on((`PC`.`IdPedido` = `PT`.`IdPedido`))) join `delivery`.`pedidos` `P` on((`P`.`IdPedido` = `PT`.`IdPedido`))) join `delivery`.`pedido_entrega` `PE` on((`PE`.`IdPedido` = `PT`.`IdPedido`))) join `delivery`.`sucursal` `S` on((`S`.`IdSucursal` = `P`.`IdSucursal`))) join `delivery`.`comercio` `C` on((`C`.`IdComercio` = `S`.`IdComercio`))) left join `delivery`.`pedido_cambio_entrega` `PCE` on(((`PCE`.`IdPedido` = `PT`.`IdPedido`) and (`PCE`.`Tipo` = 'ENTREGA')))) left join `delivery`.`pedido_courier` `PR` on((`PT`.`IdPedido` = `PR`.`IdPedido`))) left join `delivery`.`rider` `R` on((`PE`.`IdRider` = `R`.`Id_Rider`))) left join `delivery`.`pedido_courier` `COU` on((`COU`.`IdPedido` = `P`.`IdPedido`))) left join `delivery`.`tipo_courier` `TC` on((`TC`.`IdCourier` = `COU`.`IdTipoCourier`))) left join `delivery`.`sucursal_configuracion` `SC` on(((`SC`.`IdSucursal` = `S`.`IdSucursal`) and (`SC`.`IdTipoConfiguracion` = 5)))) left join `delivery`.`pedido_seguimiento_delivery` `PSD` on((`PSD`.`IdPedido` = `P`.`IdPedido`))) left join `delivery`.`pedido_preparacion_cocina` `PPC` on((`PPC`.`IdPedido` = `P`.`IdPedido`))) left join `delivery`.`pedido_estado` `PES` on((`PES`.`Id` = `P`.`IdEstado`))) left join `delivery`.`pedido_entrega_tipo_fecha_entrega` `TFE` on((`TFE`.`Id` = `PE`.`TipoFechaEntrega`))) left join `delivery`.`pedido_seguimiento` `PSS` on(((`PSS`.`IdPedido` = `P`.`IdPedido`) and (`PSS`.`IdTipoSeguimiento` = 2)))) left join `delivery`.`pedido_seguimiento` `PSC` on(((`PSC`.`IdPedido` = `P`.`IdPedido`) and (`PSC`.`IdTipoSeguimiento` = 3)))) where ((`P`.`IdEstado` <> 2) and (`P`.`IdTipoPedido` <> 5) and (date_format(convert_tz(`PT`.`FechaEstimadaEntregaMax`,'+00:00',`PT`.`OffsetUTC`),'%Y-%m-%d') < curdate()) and (`P`.`TipoEntrega` = 1))) `X`) `X`) `X` order by `X`.`FECHA_ENTREGA_MIN` desc