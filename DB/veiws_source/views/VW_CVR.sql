CREATE ALGORITHM=UNDEFINED DEFINER=`qa-general`@`%` SQL SECURITY DEFINER VIEW `VW_CVR` AS select distinct `X`.`CVR` AS `CVR`,`X`.`ID_CARRO` AS `ID_CARRO`,`X`.`ESTADO` AS `ESTADO`,`X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,`X`.`PRODUCTOS_VISTOS` AS `PRODUCTOS_VISTOS`,`X`.`CANTIDAD_PRODUCTOS` AS `CANTIDAD_PRODUCTOS`,`X`.`FUE_A_CHECKOUT` AS `FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO` AS `INTENCION_PAGO`,`X`.`PROBLEMA_BOTON_PAGO` AS `PROBLEMA_BOTON_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION` AS `FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES` AS `MES`,`X`.`ID_PEDIDO` AS `ID_PEDIDO`,`X`.`CODIGO_PEDIDO` AS `CODIGO_PEDIDO`,`X`.`CLIENTE` AS `CLIENTE`,`X`.`EMAIL_CLIENTE` AS `EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE` AS `TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL` AS `SUBTOTAL`,`X`.`TOTAL_OC` AS `TOTAL_OC`,`X`.`FECHA_ENTREGA` AS `FECHA_ENTREGA`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`MEDIO_PAGO` AS `MEDIO_PAGO`,`X`.`CUPON` AS `CUPON`,`X`.`DSCTO_SUBTOTAL` AS `DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO` AS `DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` AS `DSCTO_PUNTOS` from (select `X`.`CVR` AS `CVR`,`X`.`ID_CARRO` AS `ID_CARRO`,`X`.`ESTADO` AS `ESTADO`,`X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,sum(ifnull(`X`.`PRODUCTOS_VISTOS`,0)) AS `PRODUCTOS_VISTOS`,sum(ifnull(`X`.`CANTIDAD_PRODUCTOS`,0)) AS `CANTIDAD_PRODUCTOS`,`X`.`FUE_A_CHECKOUT` AS `FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO` AS `INTENCION_PAGO`,group_concat(distinct `X`.`PROBLEMA_BOTON_PAGO` separator ' | ') AS `PROBLEMA_BOTON_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION` AS `FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES` AS `MES`,`X`.`ID_PEDIDO` AS `ID_PEDIDO`,`X`.`CODIGO_PEDIDO` AS `CODIGO_PEDIDO`,`X`.`CLIENTE` AS `CLIENTE`,`X`.`EMAIL_CLIENTE` AS `EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE` AS `TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL` AS `SUBTOTAL`,`X`.`TOTAL_OC` AS `TOTAL_OC`,`X`.`FECHA_ENTREGA` AS `FECHA_ENTREGA`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`MEDIO_PAGO` AS `MEDIO_PAGO`,`X`.`CUPON` AS `CUPON`,`X`.`DSCTO_SUBTOTAL` AS `DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO` AS `DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` AS `DSCTO_PUNTOS` from (select distinct `C`.`CVR` AS `CVR`,`C`.`Codigo` AS `ID_CARRO`,`C`.`Estado` AS `ESTADO`,`CO`.`Nombre` AS `COMERCIO`,`S`.`Titulo` AS `SUCURSAL`,0 AS `CANTIDAD_PRODUCTOS`,'NO' AS `FUE_A_CHECKOUT`,'NO' AS `INTENCION_PAGO`,NULL AS `PROBLEMA_BOTON_PAGO`,`C`.`updatedAt` AS `FECHA_ULTIMA_ACTUALIZACION`,0 AS `PRODUCTOS_VISTOS`,(case when (month(`C`.`updatedAt`) = 1) then 'Enero' when (month(`C`.`updatedAt`) = 2) then 'Febrero' when (month(`C`.`updatedAt`) = 3) then 'Marzo' when (month(`C`.`updatedAt`) = 4) then 'Abril' when (month(`C`.`updatedAt`) = 5) then 'Mayo' when (month(`C`.`updatedAt`) = 6) then 'Junio' when (month(`C`.`updatedAt`) = 7) then 'Julio' when (month(`C`.`updatedAt`) = 8) then 'Agosto' when (month(`C`.`updatedAt`) = 9) then 'Septiembre' when (month(`C`.`updatedAt`) = 10) then 'Octubre' when (month(`C`.`updatedAt`) = 11) then 'Noviembre' when (month(`C`.`updatedAt`) = 12) then 'Diciembre' end) AS `MES`,NULL AS `ID_PEDIDO`,NULL AS `CODIGO_PEDIDO`,concat(`U`.`Nombre`,' ',ifnull(`U`.`Apellido`,'')) AS `CLIENTE`,`U`.`Email` AS `EMAIL_CLIENTE`,`U`.`Telefono` AS `TELEFONO_CLIENTE`,(case when (`C`.`IdTipoEntrega` = 1) then 'Delivery' when (`C`.`IdTipoEntrega` = 2) then 'Retiro en Tienda' end) AS `TIPO_ENTREGA`,(case when (`C`.`IdTipoFechaEntrega` = 1) then 'Lo antes posible' when (`C`.`IdTipoFechaEntrega` = 3) then 'Lo antes posible' end) AS `TIPO_FECHA_ENTREGA`,0 AS `SUBTOTAL`,0 AS `TOTAL_OC`,concat(`C`.`FechaEntregaProg`,ifnull(concat(' ',`C`.`HoraEntregaProg`),'')) AS `FECHA_ENTREGA`,NULL AS `FECHA_PAGO`,NULL AS `ESTADO_PEDIDO`,NULL AS `MEDIO_PAGO`,NULL AS `CUPON`,0 AS `DSCTO_SUBTOTAL`,0 AS `DSCTO_GASTO_ENVIO`,0 AS `DSCTO_PUNTOS` from (((`delivery`.`carro` `C` join `delivery`.`sucursal` `S` on((`S`.`IdSucursal` = `C`.`IdSucursal`))) join `delivery`.`comercio` `CO` on((`CO`.`IdComercio` = `S`.`IdComercio`))) left join `delivery`.`usuario` `U` on((`U`.`IdUsuario` = `C`.`IdCliente`))) where ((date_format(`C`.`updatedAt`,'%Y-%m-%d') >= date_format((now() - interval (((weekday(now()) + 7) % 7) + 7) day),'%Y-%m-%d')) and (`C`.`Estado` in ('OBSOLETO','EXPIRADO','EN_CURSO')) and (`C`.`Tipo` = 'SUCURSAL') and (`C`.`CVR` = 'CVR0') and (`C`.`SeAgregoProductos` = 0))) `X` group by `X`.`CVR`,`X`.`ID_CARRO`,`X`.`ESTADO`,`X`.`COMERCIO`,`X`.`SUCURSAL`,`X`.`FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES`,`X`.`ID_PEDIDO`,`X`.`CODIGO_PEDIDO`,`X`.`CLIENTE`,`X`.`EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL`,`X`.`TOTAL_OC`,`X`.`FECHA_ENTREGA`,`X`.`FECHA_PAGO`,`X`.`ESTADO_PEDIDO`,`X`.`MEDIO_PAGO`,`X`.`CUPON`,`X`.`DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` union all select `X`.`CVR` AS `CVR`,`X`.`ID_CARRO` AS `ID_CARRO`,`X`.`ESTADO` AS `ESTADO`,`X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,sum(ifnull(`X`.`PRODUCTOS_VISTOS`,0)) AS `PRODUCTOS_VISTOS`,sum(ifnull(`X`.`CANTIDAD_PRODUCTOS`,0)) AS `CANTIDAD_PRODUCTOS`,`X`.`FUE_A_CHECKOUT` AS `FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO` AS `INTENCION_PAGO`,group_concat(distinct `X`.`PROBLEMA_BOTON_PAGO` separator ' | ') AS `PROBLEMA_BOTON_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION` AS `FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES` AS `MES`,`X`.`ID_PEDIDO` AS `ID_PEDIDO`,`X`.`CODIGO_PEDIDO` AS `CODIGO_PEDIDO`,`X`.`CLIENTE` AS `CLIENTE`,`X`.`EMAIL_CLIENTE` AS `EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE` AS `TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL` AS `SUBTOTAL`,`X`.`TOTAL_OC` AS `TOTAL_OC`,`X`.`FECHA_ENTREGA` AS `FECHA_ENTREGA`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`MEDIO_PAGO` AS `MEDIO_PAGO`,`X`.`CUPON` AS `CUPON`,`X`.`DSCTO_SUBTOTAL` AS `DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO` AS `DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` AS `DSCTO_PUNTOS` from (select distinct `C`.`CVR` AS `CVR`,`C`.`Codigo` AS `ID_CARRO`,`C`.`Estado` AS `ESTADO`,`CO`.`Nombre` AS `COMERCIO`,`S`.`Titulo` AS `SUCURSAL`,0 AS `CANTIDAD_PRODUCTOS`,'NO' AS `FUE_A_CHECKOUT`,'NO' AS `INTENCION_PAGO`,NULL AS `PROBLEMA_BOTON_PAGO`,`C`.`updatedAt` AS `FECHA_ULTIMA_ACTUALIZACION`,if((`VI`.`Evento` is not null),1,0) AS `PRODUCTOS_VISTOS`,(case when (month(`C`.`updatedAt`) = 1) then 'Enero' when (month(`C`.`updatedAt`) = 2) then 'Febrero' when (month(`C`.`updatedAt`) = 3) then 'Marzo' when (month(`C`.`updatedAt`) = 4) then 'Abril' when (month(`C`.`updatedAt`) = 5) then 'Mayo' when (month(`C`.`updatedAt`) = 6) then 'Junio' when (month(`C`.`updatedAt`) = 7) then 'Julio' when (month(`C`.`updatedAt`) = 8) then 'Agosto' when (month(`C`.`updatedAt`) = 9) then 'Septiembre' when (month(`C`.`updatedAt`) = 10) then 'Octubre' when (month(`C`.`updatedAt`) = 11) then 'Noviembre' when (month(`C`.`updatedAt`) = 12) then 'Diciembre' end) AS `MES`,NULL AS `ID_PEDIDO`,NULL AS `CODIGO_PEDIDO`,concat(`U`.`Nombre`,' ',ifnull(`U`.`Apellido`,'')) AS `CLIENTE`,`U`.`Email` AS `EMAIL_CLIENTE`,`U`.`Telefono` AS `TELEFONO_CLIENTE`,(case when (`C`.`IdTipoEntrega` = 1) then 'Delivery' when (`C`.`IdTipoEntrega` = 2) then 'Retiro en Tienda' end) AS `TIPO_ENTREGA`,(case when (`C`.`IdTipoFechaEntrega` = 1) then 'Lo antes posible' when (`C`.`IdTipoFechaEntrega` = 3) then 'Lo antes posible' end) AS `TIPO_FECHA_ENTREGA`,0 AS `SUBTOTAL`,0 AS `TOTAL_OC`,concat(`C`.`FechaEntregaProg`,ifnull(concat(' ',`C`.`HoraEntregaProg`),'')) AS `FECHA_ENTREGA`,NULL AS `FECHA_PAGO`,NULL AS `ESTADO_PEDIDO`,NULL AS `MEDIO_PAGO`,NULL AS `CUPON`,0 AS `DSCTO_SUBTOTAL`,0 AS `DSCTO_GASTO_ENVIO`,0 AS `DSCTO_PUNTOS` from ((((`delivery`.`carro` `C` join `delivery`.`sucursal` `S` on((`S`.`IdSucursal` = `C`.`IdSucursal`))) join `delivery`.`comercio` `CO` on((`CO`.`IdComercio` = `S`.`IdComercio`))) left join `delivery`.`carro_log` `VI` on(((`VI`.`IdCarro` = `C`.`Id`) and (`VI`.`Evento` = 'ACTION_PRODUCT_VIEW')))) left join `delivery`.`usuario` `U` on((`U`.`IdUsuario` = `C`.`IdCliente`))) where ((date_format(`C`.`updatedAt`,'%Y-%m-%d') >= date_format((now() - interval (((weekday(now()) + 7) % 7) + 7) day),'%Y-%m-%d')) and (`C`.`Estado` in ('OBSOLETO','EXPIRADO','EN_CURSO')) and (`C`.`Tipo` = 'SUCURSAL') and (`C`.`CVR` in ('CVR0','CVR1')) and (`C`.`SeAgregoProductos` = 0))) `X` group by `X`.`CVR`,`X`.`ID_CARRO`,`X`.`ESTADO`,`X`.`COMERCIO`,`X`.`SUCURSAL`,`X`.`FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES`,`X`.`ID_PEDIDO`,`X`.`CODIGO_PEDIDO`,`X`.`CLIENTE`,`X`.`EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL`,`X`.`TOTAL_OC`,`X`.`FECHA_ENTREGA`,`X`.`FECHA_PAGO`,`X`.`ESTADO_PEDIDO`,`X`.`MEDIO_PAGO`,`X`.`CUPON`,`X`.`DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` union all select `X`.`CVR` AS `CVR`,`X`.`ID_CARRO` AS `ID_CARRO`,`X`.`ESTADO` AS `ESTADO`,`X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,sum(ifnull(`X`.`PRODUCTOS_VISTOS`,0)) AS `PRODUCTOS_VISTOS`,sum(ifnull(`X`.`CANTIDAD_PRODUCTOS`,0)) AS `CANTIDAD_PRODUCTOS`,`X`.`FUE_A_CHECKOUT` AS `FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO` AS `INTENCION_PAGO`,group_concat(distinct `X`.`PROBLEMA_BOTON_PAGO` separator ' | ') AS `PROBLEMA_BOTON_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION` AS `FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES` AS `MES`,`X`.`ID_PEDIDO` AS `ID_PEDIDO`,`X`.`CODIGO_PEDIDO` AS `CODIGO_PEDIDO`,`X`.`CLIENTE` AS `CLIENTE`,`X`.`EMAIL_CLIENTE` AS `EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE` AS `TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL` AS `SUBTOTAL`,`X`.`TOTAL_OC` AS `TOTAL_OC`,`X`.`FECHA_ENTREGA` AS `FECHA_ENTREGA`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`MEDIO_PAGO` AS `MEDIO_PAGO`,`X`.`CUPON` AS `CUPON`,`X`.`DSCTO_SUBTOTAL` AS `DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO` AS `DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` AS `DSCTO_PUNTOS` from (select distinct `C`.`CVR` AS `CVR`,`C`.`Codigo` AS `ID_CARRO`,`C`.`Estado` AS `ESTADO`,`CO`.`Nombre` AS `COMERCIO`,`S`.`Titulo` AS `SUCURSAL`,ifnull(`PR`.`Cantidad`,0) AS `CANTIDAD_PRODUCTOS`,'NO' AS `FUE_A_CHECKOUT`,'NO' AS `INTENCION_PAGO`,NULL AS `PROBLEMA_BOTON_PAGO`,`C`.`updatedAt` AS `FECHA_ULTIMA_ACTUALIZACION`,if((`VI`.`Evento` is not null),1,0) AS `PRODUCTOS_VISTOS`,(case when (month(`C`.`updatedAt`) = 1) then 'Enero' when (month(`C`.`updatedAt`) = 2) then 'Febrero' when (month(`C`.`updatedAt`) = 3) then 'Marzo' when (month(`C`.`updatedAt`) = 4) then 'Abril' when (month(`C`.`updatedAt`) = 5) then 'Mayo' when (month(`C`.`updatedAt`) = 6) then 'Junio' when (month(`C`.`updatedAt`) = 7) then 'Julio' when (month(`C`.`updatedAt`) = 8) then 'Agosto' when (month(`C`.`updatedAt`) = 9) then 'Septiembre' when (month(`C`.`updatedAt`) = 10) then 'Octubre' when (month(`C`.`updatedAt`) = 11) then 'Noviembre' when (month(`C`.`updatedAt`) = 12) then 'Diciembre' end) AS `MES`,NULL AS `ID_PEDIDO`,NULL AS `CODIGO_PEDIDO`,concat(`U`.`Nombre`,' ',ifnull(`U`.`Apellido`,'')) AS `CLIENTE`,`U`.`Email` AS `EMAIL_CLIENTE`,`U`.`Telefono` AS `TELEFONO_CLIENTE`,(case when (`C`.`IdTipoEntrega` = 1) then 'Delivery' when (`C`.`IdTipoEntrega` = 2) then 'Retiro en Tienda' end) AS `TIPO_ENTREGA`,(case when (`C`.`IdTipoFechaEntrega` = 1) then 'Lo antes posible' when (`C`.`IdTipoFechaEntrega` = 3) then 'Lo antes posible' end) AS `TIPO_FECHA_ENTREGA`,0 AS `SUBTOTAL`,0 AS `TOTAL_OC`,concat(`C`.`FechaEntregaProg`,ifnull(concat(' ',`C`.`HoraEntregaProg`),'')) AS `FECHA_ENTREGA`,NULL AS `FECHA_PAGO`,NULL AS `ESTADO_PEDIDO`,NULL AS `MEDIO_PAGO`,NULL AS `CUPON`,0 AS `DSCTO_SUBTOTAL`,0 AS `DSCTO_GASTO_ENVIO`,0 AS `DSCTO_PUNTOS` from (((((`delivery`.`carro` `C` join `delivery`.`sucursal` `S` on((`S`.`IdSucursal` = `C`.`IdSucursal`))) join `delivery`.`comercio` `CO` on((`CO`.`IdComercio` = `S`.`IdComercio`))) left join `delivery`.`carro_log` `VI` on(((`VI`.`IdCarro` = `C`.`Id`) and (`VI`.`Evento` = 'ACTION_PRODUCT_VIEW')))) left join `delivery`.`usuario` `U` on((`U`.`IdUsuario` = `C`.`IdCliente`))) left join `delivery`.`carro_producto` `PR` on((`PR`.`IdCarro` = `C`.`Id`))) where ((date_format(`C`.`updatedAt`,'%Y-%m-%d') >= date_format((now() - interval (((weekday(now()) + 7) % 7) + 7) day),'%Y-%m-%d')) and (`C`.`Estado` in ('OBSOLETO','EXPIRADO','EN_CURSO')) and (`C`.`Tipo` = 'SUCURSAL') and (`C`.`CVR` in ('CVR0','CVR1','CVR2')) and (`C`.`SeAgregoProductos` = 1))) `X` group by `X`.`CVR`,`X`.`ID_CARRO`,`X`.`ESTADO`,`X`.`COMERCIO`,`X`.`SUCURSAL`,`X`.`FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES`,`X`.`ID_PEDIDO`,`X`.`CODIGO_PEDIDO`,`X`.`CLIENTE`,`X`.`EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL`,`X`.`TOTAL_OC`,`X`.`FECHA_ENTREGA`,`X`.`FECHA_PAGO`,`X`.`ESTADO_PEDIDO`,`X`.`MEDIO_PAGO`,`X`.`CUPON`,`X`.`DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` union all select `X`.`CVR` AS `CVR`,`X`.`ID_CARRO` AS `ID_CARRO`,`X`.`ESTADO` AS `ESTADO`,`X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,sum(ifnull(`X`.`PRODUCTOS_VISTOS`,0)) AS `PRODUCTOS_VISTOS`,sum(ifnull(`X`.`CANTIDAD_PRODUCTOS`,0)) AS `CANTIDAD_PRODUCTOS`,`X`.`FUE_A_CHECKOUT` AS `FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO` AS `INTENCION_PAGO`,group_concat(distinct `X`.`PROBLEMA_BOTON_PAGO` separator ' | ') AS `PROBLEMA_BOTON_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION` AS `FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES` AS `MES`,`X`.`ID_PEDIDO` AS `ID_PEDIDO`,`X`.`CODIGO_PEDIDO` AS `CODIGO_PEDIDO`,`X`.`CLIENTE` AS `CLIENTE`,`X`.`EMAIL_CLIENTE` AS `EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE` AS `TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL` AS `SUBTOTAL`,`X`.`TOTAL_OC` AS `TOTAL_OC`,`X`.`FECHA_ENTREGA` AS `FECHA_ENTREGA`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`MEDIO_PAGO` AS `MEDIO_PAGO`,`X`.`CUPON` AS `CUPON`,`X`.`DSCTO_SUBTOTAL` AS `DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO` AS `DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` AS `DSCTO_PUNTOS` from (select distinct `C`.`CVR` AS `CVR`,`C`.`Codigo` AS `ID_CARRO`,`C`.`Estado` AS `ESTADO`,`CO`.`Nombre` AS `COMERCIO`,`S`.`Titulo` AS `SUCURSAL`,ifnull(`PR`.`Cantidad`,0) AS `CANTIDAD_PRODUCTOS`,if((`CH`.`Evento` is not null),'SI','NO') AS `FUE_A_CHECKOUT`,if((`TR`.`Evento` is not null),'SI','NO') AS `INTENCION_PAGO`,NULL AS `PROBLEMA_BOTON_PAGO`,`C`.`updatedAt` AS `FECHA_ULTIMA_ACTUALIZACION`,if((`VI`.`Evento` is not null),1,0) AS `PRODUCTOS_VISTOS`,(case when (month(`C`.`updatedAt`) = 1) then 'Enero' when (month(`C`.`updatedAt`) = 2) then 'Febrero' when (month(`C`.`updatedAt`) = 3) then 'Marzo' when (month(`C`.`updatedAt`) = 4) then 'Abril' when (month(`C`.`updatedAt`) = 5) then 'Mayo' when (month(`C`.`updatedAt`) = 6) then 'Junio' when (month(`C`.`updatedAt`) = 7) then 'Julio' when (month(`C`.`updatedAt`) = 8) then 'Agosto' when (month(`C`.`updatedAt`) = 9) then 'Septiembre' when (month(`C`.`updatedAt`) = 10) then 'Octubre' when (month(`C`.`updatedAt`) = 11) then 'Noviembre' when (month(`C`.`updatedAt`) = 12) then 'Diciembre' end) AS `MES`,NULL AS `ID_PEDIDO`,NULL AS `CODIGO_PEDIDO`,concat(`U`.`Nombre`,' ',ifnull(`U`.`Apellido`,'')) AS `CLIENTE`,`U`.`Email` AS `EMAIL_CLIENTE`,`U`.`Telefono` AS `TELEFONO_CLIENTE`,(case when (`C`.`IdTipoEntrega` = 1) then 'Delivery' when (`C`.`IdTipoEntrega` = 2) then 'Retiro en Tienda' end) AS `TIPO_ENTREGA`,(case when (`C`.`IdTipoFechaEntrega` = 1) then 'Lo antes posible' when (`C`.`IdTipoFechaEntrega` = 3) then 'Lo antes posible' end) AS `TIPO_FECHA_ENTREGA`,0 AS `SUBTOTAL`,0 AS `TOTAL_OC`,concat(`C`.`FechaEntregaProg`,ifnull(concat(' ',`C`.`HoraEntregaProg`),'')) AS `FECHA_ENTREGA`,NULL AS `FECHA_PAGO`,NULL AS `ESTADO_PEDIDO`,`M`.`medio_pago` AS `MEDIO_PAGO`,`C`.`CuponTexto` AS `CUPON`,0 AS `DSCTO_SUBTOTAL`,0 AS `DSCTO_GASTO_ENVIO`,0 AS `DSCTO_PUNTOS` from ((((((((`delivery`.`carro` `C` join `delivery`.`sucursal` `S` on((`S`.`IdSucursal` = `C`.`IdSucursal`))) join `delivery`.`comercio` `CO` on((`CO`.`IdComercio` = `S`.`IdComercio`))) left join `delivery`.`carro_log` `VI` on(((`VI`.`IdCarro` = `C`.`Id`) and (`VI`.`Evento` = 'ACTION_PRODUCT_VIEW')))) left join `delivery`.`carro_log` `CH` on(((`CH`.`IdCarro` = `C`.`Id`) and (`CH`.`Evento` = 'ACTION_GO_TO_CHECKOUT')))) left join `delivery`.`carro_log` `TR` on(((`TR`.`IdCarro` = `C`.`Id`) and (`TR`.`Evento` = 'INIT_TRANSACTION')))) left join `delivery`.`usuario` `U` on((`U`.`IdUsuario` = `C`.`IdCliente`))) left join `delivery`.`carro_producto` `PR` on((`PR`.`IdCarro` = `C`.`Id`))) left join `delivery`.`medio_pago` `M` on((`M`.`id` = `C`.`IdMedioPago`))) where ((date_format(`C`.`updatedAt`,'%Y-%m-%d') >= date_format((now() - interval (((weekday(now()) + 7) % 7) + 7) day),'%Y-%m-%d')) and (`C`.`Estado` in ('OBSOLETO','EXPIRADO','EN_CURSO')) and (`C`.`Tipo` = 'SUCURSAL') and (`C`.`CVR` in ('CVR0','CVR1','CVR2','CVR3')) and (`C`.`SeAgregoProductos` = 1))) `X` group by `X`.`CVR`,`X`.`ID_CARRO`,`X`.`ESTADO`,`X`.`COMERCIO`,`X`.`SUCURSAL`,`X`.`FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES`,`X`.`ID_PEDIDO`,`X`.`CODIGO_PEDIDO`,`X`.`CLIENTE`,`X`.`EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL`,`X`.`TOTAL_OC`,`X`.`FECHA_ENTREGA`,`X`.`FECHA_PAGO`,`X`.`ESTADO_PEDIDO`,`X`.`MEDIO_PAGO`,`X`.`CUPON`,`X`.`DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` union all select `X`.`CVR` AS `CVR`,`X`.`ID_CARRO` AS `ID_CARRO`,`X`.`ESTADO` AS `ESTADO`,`X`.`COMERCIO` AS `COMERCIO`,`X`.`SUCURSAL` AS `SUCURSAL`,sum(ifnull(`X`.`PRODUCTOS_VISTOS`,0)) AS `PRODUCTOS_VISTOS`,sum(ifnull(`X`.`CANTIDAD_PRODUCTOS`,0)) AS `CANTIDAD_PRODUCTOS`,`X`.`FUE_A_CHECKOUT` AS `FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO` AS `INTENCION_PAGO`,group_concat(distinct `X`.`PROBLEMA_BOTON_PAGO` separator ' | ') AS `PROBLEMA_BOTON_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION` AS `FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES` AS `MES`,`X`.`ID_PEDIDO` AS `ID_PEDIDO`,`X`.`CODIGO_PEDIDO` AS `CODIGO_PEDIDO`,`X`.`CLIENTE` AS `CLIENTE`,`X`.`EMAIL_CLIENTE` AS `EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE` AS `TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA` AS `TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA` AS `TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL` AS `SUBTOTAL`,`X`.`TOTAL_OC` AS `TOTAL_OC`,`X`.`FECHA_ENTREGA` AS `FECHA_ENTREGA`,`X`.`FECHA_PAGO` AS `FECHA_PAGO`,`X`.`ESTADO_PEDIDO` AS `ESTADO_PEDIDO`,`X`.`MEDIO_PAGO` AS `MEDIO_PAGO`,`X`.`CUPON` AS `CUPON`,`X`.`DSCTO_SUBTOTAL` AS `DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO` AS `DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS` AS `DSCTO_PUNTOS` from (select distinct `C`.`CVR` AS `CVR`,`C`.`Codigo` AS `ID_CARRO`,`C`.`Estado` AS `ESTADO`,`CO`.`Nombre` AS `COMERCIO`,`S`.`Titulo` AS `SUCURSAL`,ifnull(`PR`.`Cantidad`,0) AS `CANTIDAD_PRODUCTOS`,if((`CH`.`Evento` is not null),'SI','NO') AS `FUE_A_CHECKOUT`,'SI' AS `INTENCION_PAGO`,`TR`.`Valor` AS `PROBLEMA_BOTON_PAGO`,`C`.`updatedAt` AS `FECHA_ULTIMA_ACTUALIZACION`,if((`VI`.`Evento` is not null),1,0) AS `PRODUCTOS_VISTOS`,(case when (month(`C`.`updatedAt`) = 1) then 'Enero' when (month(`C`.`updatedAt`) = 2) then 'Febrero' when (month(`C`.`updatedAt`) = 3) then 'Marzo' when (month(`C`.`updatedAt`) = 4) then 'Abril' when (month(`C`.`updatedAt`) = 5) then 'Mayo' when (month(`C`.`updatedAt`) = 6) then 'Junio' when (month(`C`.`updatedAt`) = 7) then 'Julio' when (month(`C`.`updatedAt`) = 8) then 'Agosto' when (month(`C`.`updatedAt`) = 9) then 'Septiembre' when (month(`C`.`updatedAt`) = 10) then 'Octubre' when (month(`C`.`updatedAt`) = 11) then 'Noviembre' when (month(`C`.`updatedAt`) = 12) then 'Diciembre' end) AS `MES`,`P`.`IdPedido` AS `ID_PEDIDO`,concat(`P`.`Codigo`,'-',`P`.`Corelativo`) AS `CODIGO_PEDIDO`,concat(`U`.`Nombre`,' ',ifnull(`U`.`Apellido`,'')) AS `CLIENTE`,`U`.`Email` AS `EMAIL_CLIENTE`,`U`.`Telefono` AS `TELEFONO_CLIENTE`,(case when (ifnull(`PE`.`TipoEntrega`,`C`.`IdTipoEntrega`) = 1) then 'Delivery' when (ifnull(`PE`.`TipoEntrega`,`C`.`IdTipoEntrega`) = 2) then 'Retiro en Tienda' end) AS `TIPO_ENTREGA`,(case when (ifnull(`PE`.`TipoFechaEntrega`,`C`.`IdTipoFechaEntrega`) = 1) then 'Lo antes posible' when (ifnull(`PE`.`TipoFechaEntrega`,`C`.`IdTipoFechaEntrega`) = 3) then 'Lo antes posible' end) AS `TIPO_FECHA_ENTREGA`,ifnull(ifnull(`P`.`SubTotal`,`C`.`Total`),0) AS `SUBTOTAL`,ifnull(ifnull(`P`.`Total_OC`,`C`.`Total`),0) AS `TOTAL_OC`,ifnull(`PE`.`FechaEstimadaEntregaMax`,concat(`C`.`FechaEntregaProg`,ifnull(concat(' ',`C`.`HoraEntregaProg`),''))) AS `FECHA_ENTREGA`,date_format(`PPR`.`fecha`,'%Y-%m-%d %H:%i:00') AS `FECHA_PAGO`,`PES`.`Nombre` AS `ESTADO_PEDIDO`,`M`.`medio_pago` AS `MEDIO_PAGO`,`C`.`CuponTexto` AS `CUPON`,ifnull(`P`.`DsctoCuponSubtotal`,0) AS `DSCTO_SUBTOTAL`,ifnull(`P`.`DsctoCuponGastoEnvio`,0) AS `DSCTO_GASTO_ENVIO`,ifnull(`P`.`DsctoPuntos`,0) AS `DSCTO_PUNTOS` from (((((((((((((`delivery`.`carro` `C` join `delivery`.`sucursal` `S` on((`S`.`IdSucursal` = `C`.`IdSucursal`))) join `delivery`.`comercio` `CO` on((`CO`.`IdComercio` = `S`.`IdComercio`))) left join `delivery`.`carro_log` `VI` on(((`VI`.`IdCarro` = `C`.`Id`) and (`VI`.`Evento` = 'ACTION_PRODUCT_VIEW')))) left join `delivery`.`carro_log` `CH` on(((`CH`.`IdCarro` = `C`.`Id`) and (`CH`.`Evento` = 'ACTION_GO_TO_CHECKOUT')))) left join `delivery`.`carro_log` `TR` on(((`TR`.`IdCarro` = `C`.`Id`) and (`TR`.`Evento` = 'INIT_TRANSACTION')))) left join `delivery`.`carro_producto` `PR` on((`PR`.`IdCarro` = `C`.`Id`))) left join `delivery`.`usuario` `U` on((`U`.`IdUsuario` = `C`.`IdCliente`))) left join `delivery`.`medio_pago` `M` on((`M`.`id` = `C`.`IdMedioPago`))) left join `delivery`.`pedidos` `P` on(((`P`.`IdCarro` = `C`.`Id`) and (`P`.`IdEstado` <> 2)))) left join `delivery`.`pedido_entrega` `PE` on((`PE`.`IdPedido` = `P`.`IdPedido`))) left join `delivery`.`pedido_pago` `PP` on((`PP`.`IdPedido` = `P`.`IdPedido`))) left join `delivery`.`pedido_pago_respuesta` `PPR` on((`PPR`.`idPago` = `PP`.`IdPago`))) left join `delivery`.`pedido_estado` `PES` on((`PES`.`Id` = `P`.`IdEstado`))) where ((date_format(`C`.`updatedAt`,'%Y-%m-%d') >= date_format((now() - interval (((weekday(now()) + 7) % 7) + 7) day),'%Y-%m-%d')) and (`C`.`Estado` = 'PAGADO') and (`C`.`Tipo` = 'SUCURSAL') and (`C`.`CVR` in ('CVR0','CVR1','CVR2','CVR3','PAGADO')) and (`C`.`SeAgregoProductos` = 1))) `X` group by `X`.`CVR`,`X`.`ID_CARRO`,`X`.`ESTADO`,`X`.`COMERCIO`,`X`.`SUCURSAL`,`X`.`FUE_A_CHECKOUT`,`X`.`INTENCION_PAGO`,`X`.`FECHA_ULTIMA_ACTUALIZACION`,`X`.`MES`,`X`.`ID_PEDIDO`,`X`.`CODIGO_PEDIDO`,`X`.`CLIENTE`,`X`.`EMAIL_CLIENTE`,`X`.`TELEFONO_CLIENTE`,`X`.`TIPO_ENTREGA`,`X`.`TIPO_FECHA_ENTREGA`,`X`.`SUBTOTAL`,`X`.`TOTAL_OC`,`X`.`FECHA_ENTREGA`,`X`.`FECHA_PAGO`,`X`.`ESTADO_PEDIDO`,`X`.`MEDIO_PAGO`,`X`.`CUPON`,`X`.`DSCTO_SUBTOTAL`,`X`.`DSCTO_GASTO_ENVIO`,`X`.`DSCTO_PUNTOS`) `X` order by `X`.`CVR`,`X`.`ID_CARRO`,`X`.`FECHA_ULTIMA_ACTUALIZACION`