CREATE ALGORITHM=UNDEFINED DEFINER=`qa-general`@`%` SQL SECURITY DEFINER VIEW `VW_AnalisisKam` AS select distinct `X`.`IdPedido` AS `Pedidos`,`X`.`Comercio` AS `Comercio`,`X`.`Sucursal` AS `Sucursal`,cast(date_format(`X`.`FechaEstimadaEntregaMin`,'%Y-%m-%d') as date) AS `Fecha`,(case when (dayname(`X`.`FechaEstimadaEntregaMin`) = 'Monday') then 'Lunes' when (dayname(`X`.`FechaEstimadaEntregaMin`) = 'Tuesday') then 'Martes' when (dayname(`X`.`FechaEstimadaEntregaMin`) = 'Wednesday') then 'Miercoles' when (dayname(`X`.`FechaEstimadaEntregaMin`) = 'Thursday') then 'Jueves' when (dayname(`X`.`FechaEstimadaEntregaMin`) = 'Friday') then 'Viernes' when (dayname(`X`.`FechaEstimadaEntregaMin`) = 'Saturday') then 'Sabado' when (dayname(`X`.`FechaEstimadaEntregaMin`) = 'Sunday') then 'Domingo' end) AS `Dia`,if((dayname(`X`.`FechaEstimadaEntregaMin`) = 'Monday'),`X`.`Subtotal`,0) AS `Lunes`,if((dayname(`X`.`FechaEstimadaEntregaMin`) = 'Tuesday'),`X`.`Subtotal`,0) AS `Martes`,if((dayname(`X`.`FechaEstimadaEntregaMin`) = 'Wednesday'),`X`.`Subtotal`,0) AS `Miercoles`,if((dayname(`X`.`FechaEstimadaEntregaMin`) = 'Thursday'),`X`.`Subtotal`,0) AS `Jueves`,if((dayname(`X`.`FechaEstimadaEntregaMin`) = 'Friday'),`X`.`Subtotal`,0) AS `Viernes`,if((dayname(`X`.`FechaEstimadaEntregaMin`) = 'Saturday'),`X`.`Subtotal`,0) AS `Sabado`,if((dayname(`X`.`FechaEstimadaEntregaMin`) = 'Sunday'),`X`.`Subtotal`,0) AS `Domingo`,`X`.`EstadoPedido` AS `EstadoPedido`,`X`.`TipoEntrega` AS `TipoEntrega`,`X`.`Subtotal` AS `Subtotal`,(ifnull(`X`.`ComisionVentaNeto`,0) + ifnull(`X`.`ComisionDeliveryNeto`,0)) AS `Fee`,`X`.`TotalBoleta` AS `TotalBoleta`,`X`.`CodigoCupon` AS `Cupones`,`X`.`DsctoCuponSubtotal` AS `DsctoCuponSubtotal`,`X`.`DsctoCuponGastoEnvio` AS `DsctoCuponGastoEnvio`,`X`.`DsctoPuntos` AS `DsctoPuntos`,ifnull(`U`.`IdUsuario`,'') AS `IdCliente`,concat(ifnull(`U`.`Nombre`,''),' ',ifnull(`U`.`Apellido`,'')) AS `NombreCliente`,ifnull(`U`.`Email`,'') AS `EmailCliente`,cast(`X`.`FechaPago` as datetime) AS `FechaHoraPago`,cast(`X`.`FechaEstimadaEntregaMin` as datetime) AS `FechaHoraEntrega` from (`dw_base_financiera` `X` left join `usuario` `U` on((`X`.`IdCliente` = `U`.`IdUsuario`))) where ((`X`.`CodigoTipoPedido` = 'PEDNORMAL') and ((`X`.`EsPedidoHijo` = 'SI') or ((`X`.`EsPedidoHijo` = 'NO') and (`X`.`EstadoPago` in ('Activo','Reembolsado')))) and (date_format(`X`.`FechaEstimadaEntregaMin`,'%Y-%m-%d') >= date_format((now() - interval (((weekday(now()) + 7) % 7) + 7) day),'%Y-%m-%d')))